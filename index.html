<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>p53 IHC Helper Pro v2.0 Fixed</title>
<style>
  :root { --pad: 16px; --radius: 12px; --maxw: 1200px; --primary: #2563eb; --success: #059669; --warning: #d97706; --danger: #dc2626; --info: #0891b2; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:#f8fafc; color:#1e293b; line-height: 1.5; }
  .wrap { max-width: var(--maxw); margin: 20px auto 60px; padding: 0 var(--pad); }
  .card { background:#fff; border-radius: var(--radius); padding: var(--pad); box-shadow: 0 4px 16px rgba(0,0,0,0.08); margin-bottom: 20px; border: 1px solid #e2e8f0; }
  .card-header { border-bottom: 1px solid #e2e8f0; margin-bottom: var(--pad); padding-bottom: 12px; }
  h1 { font-size: 1.5rem; margin: 0; color: var(--primary); font-weight: 700; }
  h2 { font-size: 1.1rem; margin: 0 0 12px; color: #374151; font-weight: 600; }
  h3 { font-size: 1rem; margin: 16px 0 8px; color: #4b5563; font-weight: 600; }
  
  .form-group { margin-bottom: 16px; }
  label { display: block; font-size: 0.9rem; font-weight: 500; margin-bottom: 6px; color: #374151; }
  input[type="number"], input[type="text"], select, textarea { width: 100%; padding: 10px 12px; border: 1.5px solid #d1d5db; border-radius: 8px; font-size: 0.95rem; transition: border-color 0.2s; box-sizing: border-box; }
  input[type="number"]:focus, input[type="text"]:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
  input[type="checkbox"] { width: auto; margin-right: 8px; }
  
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
  .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
  
  .hint { font-size: 0.82rem; color: #6b7280; margin-top: 4px; }
  .hint.important { color: var(--warning); font-weight: 500; }
  
  .btn { display: inline-block; padding: 12px 20px; border-radius: 8px; border: 0; background: var(--primary); color: #fff; font-weight: 600; cursor: pointer; font-size: 0.95rem; transition: all 0.2s; margin-right: 8px; margin-bottom: 8px; }
  .btn:hover { background: #1d4ed8; transform: translateY(-1px); }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
  .btn-secondary { background: #6b7280; }
  .btn-secondary:hover { background: #4b5563; }
  .btn-small { padding: 8px 14px; font-size: 0.85rem; }
  .btn-success { background: var(--success); }
  .btn-success:hover { background: #047857; }
  
  .badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
  .badge-wt { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
  .badge-oe { background: #fed7aa; color: #9a3412; border: 1px solid #fdba74; }
  .badge-null { background: #fecaca; color: #991b1b; border: 1px solid #fca5a5; }
  .badge-cyto { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
  .badge-ni { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
  
  .alert { padding: 12px 16px; border-radius: 8px; margin: 12px 0; border-left: 4px solid; }
  .alert-success { background: #f0fdf4; border-color: var(--success); color: #15803d; }
  .alert-warning { background: #fffbeb; border-color: var(--warning); color: #a16207; }
  .alert-danger { background: #fef2f2; border-color: var(--danger); color: #b91c1c; }
  .alert-info { background: #f0f9ff; border-color: var(--info); color: #0c4a6e; }
  
  .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin: 16px 0; }
  .metric { background: #f8fafc; padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #e2e8f0; }
  .metric-value { font-size: 1.4rem; font-weight: 700; color: var(--primary); }
  .metric-label { font-size: 0.85rem; color: #6b7280; margin-top: 4px; }
  
  .collapse-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
  .collapse-content.show { max-height: 2000px; }
  .collapse-trigger { cursor: pointer; user-select: none; color: var(--primary); }
  .collapse-trigger:hover { text-decoration: underline; }
  
  .criteria-list { background: #f8fafc; padding: 12px; border-radius: 8px; margin: 8px 0; }
  .criteria-list ul { margin: 8px 0; padding-left: 20px; }
  .criteria-list li { margin: 4px 0; font-size: 0.9rem; }
  
  .output-section { display: none; }
  .output-section.show { display: block; }
  
  .preset-buttons { display: flex; flex-wrap: wrap; gap: 8px; margin: 12px 0; }
  
  .morph-checklist label { display: flex; align-items: center; margin: 8px 0; font-weight: 400; }
  
  .report-output { background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; padding: 16px; font-family: 'Courier New', monospace; font-size: 0.9rem; white-space: pre-wrap; margin: 12px 0; max-height: 300px; overflow-y: auto; }
  
  .copy-btn { background: var(--success); }
  .copy-btn:hover { background: #047857; }
  
  .history-item { background: #f8fafc; padding: 10px; margin: 6px 0; border-radius: 6px; border-left: 3px solid var(--primary); cursor: pointer; transition: all 0.2s; }
  .history-item:hover { background: #e0e7ff; transform: translateX(4px); }
  .history-item-header { font-weight: 600; font-size: 0.9rem; }
  .history-item-detail { font-size: 0.8rem; color: #6b7280; margin-top: 2px; }
  
  .keyboard-hint { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; border-radius: 6px; font-size: 0.75rem; display: none; }
  .keyboard-hint.show { display: block; }
  
  .tiny { font-size: 0.8rem; color: #6b7280; }
  .strong { font-weight: 600; }
  
  @media (max-width: 768px) {
    .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
    .wrap { padding: 0 12px; }
    .keyboard-hint { display: none !important; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <div class="card">
      <div class="card-header">
        <h1>p53 IHC Helper Pro v2.0 Fixed</h1>
        <p class="tiny">Pattern-based interpretation - ESMO/CAP 2023-2024 ‚Ä¢ <strong>Clinical use only</strong></p>
      </div>
      <div class="alert alert-info">
        <strong>Uso clinico personale.</strong> Interpretazione finale richiede valutazione morfologica completa. Bibliografia validata: Singh 2020 (Endometrio), K√∂bel 2016/2019 (Ovaio/Generale), van den Heerik (2022). <strong>v2.0: Fix soglie organo-specifiche, POLE/MMR context, pattern mixed, H-score display.</strong>
      </div>
    </div>

    <!-- Quick Presets -->
    <div class="card">
      <h2>‚ö° Quick Entry</h2>
      <div class="preset-buttons">
        <button class="btn btn-small btn-secondary" onclick="loadPreset('classic_oe')">Classic OE</button>
        <button class="btn btn-small btn-secondary" onclick="loadPreset('null')">Null</button>
        <button class="btn btn-small btn-secondary" onclick="loadPreset('mosaic_wt')">Mosaic WT</button>
        <button class="btn btn-small btn-secondary" onclick="loadPreset('cyto')">Cytoplasmic</button>
      </div>
      <div class="hint">Preset per pattern comuni - personalizza dopo il caricamento</div>
    </div>

    <!-- Main Input Form -->
    <div class="card">
      <h2>Parametri di valutazione</h2>
      
      <div class="grid-2">
        <div class="form-group">
          <label>Tipo di tumore/organo</label>
          <select id="tumorType">
            <option value="endometrio">Carcinoma endometriale</option>
            <option value="ovaio">Carcinoma ovarico (HG sieroso)</option>
            <option value="colon">Carcinoma colon-rettale</option>
            <option value="mammella">Carcinoma mammario</option>
            <option value="polmone">Carcinoma polmonare</option>
            <option value="stomaco">Carcinoma gastrico</option>
            <option value="pancreas">Carcinoma pancreatico</option>
            <option value="vescica">Carcinoma uroteliale</option>
            <option value="sarcoma">Sarcoma</option>
            <option value="altro">Altro</option>
          </select>
          <div class="hint">‚ö†Ô∏è Soglie organo-specifiche validate per endometrio e ovaio (HGSC)</div>
        </div>
        
        <div class="form-group">
          <label>Tipo di campione</label>
          <select id="specimenType">
            <option value="biopsia">Biopsia</option>
            <option value="resezione">Resezione chirurgica</option>
            <option value="citologia">Campione citologico</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>ID caso (opzionale)</label>
        <input type="text" id="caseId" placeholder="Es: EN24-12345" />
      </div>

      <h3>Contesto molecolare</h3>
      <div class="grid-3">
        <div class="form-group">
          <label>MMR status (se noto)</label>
          <select id="mmrStatus">
            <option value="unknown">Non noto</option>
            <option value="proficient">Proficient (MMR-P)</option>
            <option value="deficient">Deficient (MMR-D)</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>POLE status (se noto)</label>
          <select id="poleStatus">
            <option value="unknown">Non noto</option>
            <option value="wildtype">Wild-type</option>
            <option value="mutated">Mutato (ultramutated)</option>
          </select>
          <div class="hint">‚ö†Ô∏è Coesistenza POLE-mut + p53-OE √® rara (~5%) - alert se presente</div>
        </div>

        <div class="form-group">
          <label>Grado istologico</label>
          <select id="grade">
            <option value="unknown">Non specificato</option>
            <option value="low">Low-grade</option>
            <option value="high">High-grade</option>
          </select>
        </div>
      </div>

      <h3>Controlli tecnici</h3>
      <div class="grid-3">
        <div class="form-group">
          <label>Controllo interno</label>
          <select id="internalControl">
            <option value="none">Assente</option>
            <option value="present">Presente (vari tipi)</option>
            <option value="endothelium">Endotelio vascolare</option>
            <option value="stromal">Cellule stromali</option>
            <option value="lymphocytes">Linfociti</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Intensit√† controllo interno</label>
          <select id="controlIntensity">
            <option value="none">N/A</option>
            <option value="weak">Debole (1+)</option>
            <option value="moderate">Moderata (2+)</option>
            <option value="strong">Forte (3+)</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Qualit√† tecnica</label>
          <select id="technicalQuality">
            <option value="optimal">Ottimale</option>
            <option value="acceptable">Accettabile</option>
            <option value="suboptimal">Subottimale</option>
            <option value="poor">Inaccettabile</option>
          </select>
        </div>
      </div>

      <h3>Quantificazione (% nuclei tumorali)</h3>
      <div class="grid-4">
        <div class="form-group">
          <label>Negativi (0)</label>
          <input type="number" id="perc0" min="0" max="100" step="5" value="0" />
        </div>
        <div class="form-group">
          <label>Deboli (1+)</label>
          <input type="number" id="perc1" min="0" max="100" step="5" value="0" />
        </div>
        <div class="form-group">
          <label>Moderati (2+)</label>
          <input type="number" id="perc2" min="0" max="100" step="5" value="0" />
        </div>
        <div class="form-group">
          <label>Forti (3+)</label>
          <input type="number" id="perc3" min="0" max="100" step="5" value="0" />
        </div>
      </div>
      <div class="hint" id="percSum">Somma: 0% - Usa multipli di 5 per rapidit√†</div>

      <h3>Pattern</h3>
      <div class="grid-2">
        <div class="form-group">
          <label>Distribuzione</label>
          <select id="distribution">
            <option value="mosaic">Eterogenea/mosaico (tipico WT)</option>
            <option value="diffuse">Diffusa/uniforme</option>
            <option value="focal">Focale</option>
            <option value="zonal">Zonale/gradiente</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Localizzazione subcellulare</label>
          <select id="localization">
            <option value="nuclear">Nucleare</option>
            <option value="cytoplasmic">Prevalentemente citoplasmatica</option>
            <option value="both">Nucleo-citoplasmatica</option>
          </select>
          <div class="hint">‚ö†Ô∏è Citoplasmatico aberrante solo se nuclei negativi/deboli</div>
        </div>
      </div>

      <div class="form-group">
        <label>Pattern aberrante specifico</label>
        <select id="specialPattern">
          <option value="none">Nessuno</option>
          <option value="rim">Pattern "rim-like" periferico</option>
          <option value="speckled">Pattern "speckled" punteggiato</option>
          <option value="excluded">Esclusione nucleare</option>
        </select>
      </div>

      <h3>Checklist morfologica correlativa</h3>
      <div class="morph-checklist">
        <label><input type="checkbox" id="morphPleomorphism" /> Marcato pleomorfismo nucleare</label>
        <label><input type="checkbox" id="morphTILs" /> TILs aumentati (>10/HPF)</label>
        <label><input type="checkbox" id="morphNecrosis" /> Necrosi tumorale estesa</label>
        <label><input type="checkbox" id="morphSerous" /> Architettura sierosa/high-grade</label>
      </div>

      <div class="form-group">
        <label>Note libere</label>
        <textarea id="additionalNotes" rows="2" placeholder="Artefatti, eterogeneit√† regionale, dubbi..."></textarea>
      </div>

      <button class="btn" id="calculateBtn">üî¨ Analizza (Ctrl+Enter)</button>
      <button class="btn btn-secondary" id="resetBtn">Reset</button>
      <button class="btn btn-secondary" id="saveHistoryBtn">üíæ Salva in cronologia</button>
    </div>

    <!-- Output Section -->
    <div class="card output-section" id="outputSection">
      <h2>Risultato interpretativo</h2>
      
      <div class="metrics" id="metricsSection"></div>
      
      <div id="mainResult" class="alert"></div>
      
      <div id="detailedAnalysis"></div>
      
      <div id="recommendations"></div>

      <div id="reportSection" style="display:none;">
        <h3>Testo per referto</h3>
        <div class="report-output" id="reportText"></div>
        <button class="btn copy-btn" id="copyReportBtn">üìã Copia testo</button>
      </div>
    </div>

    <!-- History Section -->
    <div class="card">
      <h2 class="collapse-trigger" onclick="toggleCollapse('historyContent')">üìã Cronologia recente (ultimi 5 casi)</h2>
      <div id="historyContent" class="collapse-content">
        <div id="historyList"></div>
        <button class="btn btn-secondary btn-small" onclick="clearHistory()">Cancella cronologia</button>
      </div>
    </div>

    <!-- Reference Section -->
    <div class="card">
      <h2 class="collapse-trigger" onclick="toggleCollapse('referenceContent')">üìö Criteri di riferimento e bibliografia</h2>
      <div id="referenceContent" class="collapse-content">
        <div class="criteria-list">
          <h3>Soglie organo-specifiche per over-expression (v2.0 CORRETTE)</h3>
          <ul>
            <li><strong>Endometrio:</strong> ‚â•75% nuclei 2+/3+ OR H-score ‚â•200 <span style="color:#059669">[Singh 2020 ‚úì]</span></li>
            <li><strong>Ovaio (HGSC):</strong> ‚â•80% nuclei 2+/3+ diffusi <span style="color:#059669">[K√∂bel 2016 ‚úì]</span> (v1 aveva 70% - CORRETTO)</li>
            <li><strong>Colon:</strong> ‚â•80% nuclei 2+/3+ diffusi</li>
            <li><strong>Mammella:</strong> ‚â•80% nuclei 2+/3+ OR H-score ‚â•200</li>
            <li><strong>Polmone, Stomaco, Pancreas, Sarcoma:</strong> ‚â•80-85% (conservativo)</li>
            <li><strong>NOTA:</strong> "Any intensity" threshold rimosso - era inappropriato (troppo basso)</li>
          </ul>
          
          <h3>Pattern wild-type tipici</h3>
          <ul>
            <li>Distribuzione <strong>eterogenea</strong> a mosaico (hallmark del WT)</li>
            <li>Intensit√† variabile da cellula a cellula</li>
            <li>Gradiente evidente in aree diverse</li>
            <li>MAI uniformemente forte in >80% cellule</li>
          </ul>
          
          <h3>Pattern aberranti definitivi</h3>
          <ul>
            <li><strong>Null pattern:</strong> 0% nuclei positivi + controllo interno FORTE positivo</li>
            <li><strong>Over-expression:</strong> ‚â•soglia organo-specifica + distribuzione diffusa (ora corretto per ovaio)</li>
            <li><strong>Cytoplasmic:</strong> Sequestro citoplasmatico CON nuclei negativi/deboli (non misto)</li>
            <li><strong>Aberrant nuclear:</strong> Rim-like, speckled, esclusione nucleare</li>
          </ul>
          
          <h3>Contesto molecolare (ProMisE classification)</h3>
          <ul>
            <li><strong>POLE-mutated:</strong> p53 wild-type (prognosi eccellente). ‚ö†Ô∏è p53-OE + POLE raro (~5%) - FLAG se coesistente</li>
            <li><strong>MMR-deficient:</strong> p53 wild-type (prognosi buona se p53-WT, cattiva se p53-abn)</li>
            <li><strong>p53-abnormal:</strong> alta aggressivit√†, chemiosensibilit√† platino</li>
            <li><strong>NSMP:</strong> prognosi intermedia</li>
          </ul>
          
          <h3>Troubleshooting tecnico & Pattern misti</h3>
          <ul>
            <li><strong>Null pattern con controllo weak:</strong> Ripetere colorazione - possibile falso negativo tecnico</li>
            <li><strong>Citoplasmatico puro (nuclei 0% positivi):</strong> Pattern aberrante definitivo</li>
            <li><strong>Citoplasmatico MISTO (nuclei 30-50% positivi + cyto):</strong> Nucleare-prevalente - interpretare come nucleare + note cyto</li>
            <li><strong>Pattern subclonale (<10%):</strong> Segnalare ma interpretare come wild-type complessivo</li>
            <li><strong>Artefatti da over-fixation:</strong> Possono causare falsi negativi</li>
          </ul>
        </div>
        
        <div class="alert alert-info">
          <h3>Bibliografia essenziale (v2.0)</h3>
          <div style="font-size: 0.85rem; line-height: 1.4;">
            <strong>Validazione endometrio:</strong><br>
            ‚Ä¢ Singh N, et al. p53 immunohistochemistry is an accurate surrogate for TP53 mutational analysis. <em>J Pathol</em> 2020;250:336-345 ‚≠ê (207 casi, NGS, 90.7% accuracy)<br>
            ‚Ä¢ Kommoss S, et al. Final validation of ProMisE classifier. <em>Ann Oncol</em> 2018;29:1180-1188<br><br>

            <strong>Validazione ovaio (HGSC):</strong><br>
            ‚Ä¢ K√∂bel M, et al. Optimized p53 immunohistochemistry is an accurate predictor of TP53 mutation in ovarian carcinoma. <em>J Pathol</em> 2016;240:360-371 ‚≠ê (>80% strong = OE standard)<br>
            ‚Ä¢ BAGP/UKNEQAS Guidance p53 Interpretation 2016 (>80% strong intensity)<br><br>

            <strong>Pattern-based interpretation:</strong><br>
            ‚Ä¢ K√∂bel M, Ronnett BM, Singh N, et al. Interpretation of P53 Immunohistochemistry in Endometrial Carcinomas. <em>Int J Gynecol Pathol</em> 2019;38:S123-S131<br>
            ‚Ä¢ van den Heerik ASVM, et al. PORTEC-3 molecular validation. <em>Mod Pathol</em> 2022;35:1475-1483<br><br>

            <strong>Linee guida cliniche:</strong><br>
            ‚Ä¢ ESGO/ESTRO/ESP Endometrial Carcinoma Guidelines 2021<br>
            ‚Ä¢ ESMO Clinical Practice Guidelines - Ovarian Cancer 2024<br>
            ‚Ä¢ CAP Cancer Protocols 2024
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="keyboard-hint" id="keyboardHint">Ctrl+Enter = Analizza | Ctrl+R = Reset</div>

<script>
// ============ CONFIGURATION v2.0 FIXED ============
const THRESHOLDS = {
  endometrio: { strong: 75, hscore: 200 },
  ovaio: { strong: 80, hscore: 180 },  // FIX: 70 ‚Üí 80 (K√∂bel 2016 standard)
  colon: { strong: 80, hscore: 220 },
  mammella: { strong: 80, hscore: 200 },
  polmone: { strong: 80, hscore: 200 },
  stomaco: { strong: 80, hscore: 210 },
  pancreas: { strong: 85, hscore: 220 },
  vescica: { strong: 80, hscore: 200 },
  sarcoma: { strong: 85, hscore: 220 },
  altro: { strong: 80, hscore: 200 }
};

const PRESETS = {
  classic_oe: { perc0: 5, perc1: 5, perc2: 20, perc3: 70, distribution: 'diffuse', localization: 'nuclear', specialPattern: 'none' },
  null: { perc0: 100, perc1: 0, perc2: 0, perc3: 0, distribution: 'diffuse', localization: 'nuclear', specialPattern: 'none', controlIntensity: 'strong' },
  mosaic_wt: { perc0: 40, perc1: 30, perc2: 25, perc3: 5, distribution: 'mosaic', localization: 'nuclear', specialPattern: 'none' },
  cyto: { perc0: 30, perc1: 50, perc2: 15, perc3: 5, distribution: 'diffuse', localization: 'cytoplasmic', specialPattern: 'none' }
};

// ============ UTILITY FUNCTIONS ============
function clamp(value, min, max) {
  return Math.max(min, Math.min(max, isNaN(value) ? 0 : value));
}

function toggleCollapse(id) {
  document.getElementById(id).classList.toggle('show');
}

function createBadge(text, type) {
  return `<span class="badge badge-${type}">${text}</span>`;
}

function createMetric(value, label, unit = '') {
  return `
    <div class="metric">
      <div class="metric-value">${value}${unit}</div>
      <div class="metric-label">${label}</div>
    </div>
  `;
}

// ============ PRESET LOADING ============
function loadPreset(presetName) {
  const preset = PRESETS[presetName];
  if (!preset) return;
  
  document.getElementById('perc0').value = preset.perc0;
  document.getElementById('perc1').value = preset.perc1;
  document.getElementById('perc2').value = preset.perc2;
  document.getElementById('perc3').value = preset.perc3;
  document.getElementById('distribution').value = preset.distribution;
  document.getElementById('localization').value = preset.localization;
  document.getElementById('specialPattern').value = preset.specialPattern;
  
  if (preset.controlIntensity) {
    document.getElementById('controlIntensity').value = preset.controlIntensity;
  }
  
  updatePercSum();
}

// ============ PERCENTAGE SUM MONITOR ============
function updatePercSum() {
  const sum = ['perc0', 'perc1', 'perc2', 'perc3'].reduce((total, id) => {
    return total + (parseFloat(document.getElementById(id).value) || 0);
  }, 0);
  
  const percSumEl = document.getElementById('percSum');
  const inputs = ['perc0', 'perc1', 'perc2', 'perc3'];
  
  if (Math.abs(sum - 100) <= 5) {
    percSumEl.textContent = `Somma: ${sum.toFixed(0)}% ‚úì`;
    percSumEl.className = 'hint';
    inputs.forEach(id => document.getElementById(id).style.borderColor = '#059669');
  } else if (Math.abs(sum - 100) <= 15) {
    percSumEl.textContent = `Somma: ${sum.toFixed(0)}% ‚ö†Ô∏è`;
    percSumEl.className = 'hint important';
    inputs.forEach(id => document.getElementById(id).style.borderColor = '#d97706');
  } else {
    percSumEl.textContent = `Somma: ${sum.toFixed(0)}% ‚ùå (deve essere ~100%)`;
    percSumEl.className = 'hint important';
    inputs.forEach(id => document.getElementById(id).style.borderColor = '#dc2626');
  }
}

// ============ MAIN CALCULATION ============
function calculateInterpretation() {
  // Collect form data
  const data = {
    tumorType: document.getElementById('tumorType').value,
    specimenType: document.getElementById('specimenType').value,
    caseId: document.getElementById('caseId').value,
    mmrStatus: document.getElementById('mmrStatus').value,
    poleStatus: document.getElementById('poleStatus').value,
    grade: document.getElementById('grade').value,
    internalControl: document.getElementById('internalControl').value,
    controlIntensity: document.getElementById('controlIntensity').value,
    technicalQuality: document.getElementById('technicalQuality').value,
    perc0: clamp(parseFloat(document.getElementById('perc0').value), 0, 100),
    perc1: clamp(parseFloat(document.getElementById('perc1').value), 0, 100),
    perc2: clamp(parseFloat(document.getElementById('perc2').value), 0, 100),
    perc3: clamp(parseFloat(document.getElementById('perc3').value), 0, 100),
    distribution: document.getElementById('distribution').value,
    localization: document.getElementById('localization').value,
    specialPattern: document.getElementById('specialPattern').value,
    morphPleomorphism: document.getElementById('morphPleomorphism').checked,
    morphTILs: document.getElementById('morphTILs').checked,
    morphNecrosis: document.getElementById('morphNecrosis').checked,
    morphSerous: document.getElementById('morphSerous').checked,
    additionalNotes: document.getElementById('additionalNotes').value
  };
  
  // Calculate metrics
  const metrics = calculateMetrics(data);
  
  // Quality control
  const qualityIssues = performQualityControl(data, metrics);
  
  // Determine interpretation
  const interpretation = determineInterpretation(data, metrics, qualityIssues);
  
  // Update UI
  updateOutput(interpretation, metrics, data, qualityIssues);
  
  document.getElementById('outputSection').classList.add('show');
  document.getElementById('outputSection').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function calculateMetrics(data) {
  const totalPerc = data.perc0 + data.perc1 + data.perc2 + data.perc3;
  const percAny = data.perc1 + data.perc2 + data.perc3;
  const percStrong = data.perc2 + data.perc3;
  const hScore = (data.perc1 * 1) + (data.perc2 * 2) + (data.perc3 * 3);
  
  return {
    totalPerc,
    percAny,
    percStrong,
    hScore
  };
}

function performQualityControl(data, metrics) {
  const issues = [];
  
  if (data.internalControl === 'none') {
    issues.push('Controllo interno assente - validit√† non garantita');
  }
  
  if (data.controlIntensity === 'none' || data.controlIntensity === 'weak') {
    issues.push('Controllo interno non forte - rischio falso negativo per null pattern');
  }
  
  if (data.technicalQuality === 'poor') {
    issues.push('Qualit√† tecnica inaccettabile');
  }
  
  if (Math.abs(metrics.totalPerc - 100) > 10) {
    issues.push(`Percentuali non sommano a 100% (totale: ${metrics.totalPerc.toFixed(0)}%)`);
  }
  
  return issues;
}

function determineInterpretation(data, metrics, qualityIssues) {
  const thresholds = THRESHOLDS[data.tumorType];
  
  // 1. QUALITY CONTROL FAILURES
  if (qualityIssues.length > 0 && data.technicalQuality === 'poor') {
    return {
      type: 'ni',
      title: 'Non interpretabile',
      reason: 'Problemi critici di qualit√† tecnica',
      confidence: 'N/A',
      action: 'Ripetere colorazione con controlli appropriati',
      molecular: 'N/A'
    };
  }
  
  // 2. ABERRANT PATTERNS - PURE CYTOPLASMIC (nuclei must be negative/weak)
  if (data.localization === 'cytoplasmic' && metrics.percAny <= 20) {
    return {
      type: 'cyto',
      title: 'Pattern citoplasmatico aberrante (puro)',
      reason: 'Sequestro citoplasmatico con nuclei prevalentemente negativi/deboli (<20%)',
      confidence: 'Alta',
      action: 'Pattern aberrante definitivo - refertare come p53-abnormal',
      molecular: 'Mutazione TP53 con alterazione localizzazione nucleare (NLS mutations)'
    };
  }
  
  // 3. ABERRANT PATTERNS - SPECIAL NUCLEAR
  if (data.specialPattern !== 'none') {
    const patternNames = {
      rim: 'rim-like periferico',
      speckled: 'speckled punteggiato',
      excluded: 'esclusione nucleare'
    };
    
    return {
      type: 'cyto',
      title: `Pattern aberrante (${patternNames[data.specialPattern]})`,
      reason: 'Pattern nucleare anomalo specifico',
      confidence: 'Alta',
      action: 'Pattern aberrante definitivo - refertare come p53-abnormal',
      molecular: 'Coerente con mutazione funzionale TP53'
    };
  }
  
  // 4. NULL PATTERN
  if (metrics.percAny === 0) {
    if (data.controlIntensity !== 'strong') {
      return {
        type: 'ni',
        title: 'Possibile null pattern - VALIDIT√Ä INCERTA',
        reason: 'Assenza nuclei positivi ma controllo interno non forte',
        confidence: 'Bassa',
        action: 'RIPETERE con controllo interno forte prima di refertare',
        molecular: 'Non valutabile fino a conferma tecnica'
      };
    }
    
    return {
      type: 'null',
      title: 'Pattern null (complete loss)',
      reason: 'Assenza completa di nuclei positivi + controllo interno forte',
      confidence: 'Alta',
      action: 'Pattern aberrante confermato',
      molecular: 'Coerente con alleli inattivanti (nonsense, frameshift, delezioni)'
    };
  }
  
  // 5. OVER-EXPRESSION PATTERN (v2.0: ovaio now 80% not 70%)
  const overByStrong = metrics.percStrong >= thresholds.strong;
  const overByHscore = metrics.hScore >= thresholds.hscore;
  
  // Flag POLE-mut + OE coexistence (rare, ~5%)
  let poleWarning = '';
  if (overByStrong && data.poleStatus === 'mutated') {
    poleWarning = '<div class="alert alert-warning" style="margin-top:10px;"><strong>‚ö†Ô∏è CONFLITTO MOLECOLARE:</strong> POLE-mutato coesistente con p53-OE √® raro (~5% HGSC). Verificare sequenziamento TP53 e POLE.</div>';
  }
  
  if (overByStrong || overByHscore) {
    const criteria = [];
    if (overByStrong) criteria.push(`${metrics.percStrong.toFixed(0)}% forte (‚â•${thresholds.strong}%)`);
    if (overByHscore) criteria.push(`H-score ${metrics.hScore.toFixed(0)} (‚â•${thresholds.hscore})`);
    
    return {
      type: 'oe',
      title: 'Pattern over-expression',
      reason: `Criteri soddisfatti: ${criteria.join(' | ')}`,
      confidence: 'Alta',
      action: 'Pattern aberrante confermato',
      molecular: 'Tipicamente mutazioni stabilizzanti missense (hotspots: R175, R248, R273)',
      criteria: criteria,
      poleWarning: poleWarning
    };
  }
  
  // 6. WILD-TYPE WITH CONTEXT
  let wtSubtype = 'standard';
  let wtMessage = '';
  
  if (data.poleStatus === 'mutated') {
    wtSubtype = 'pole';
    wtMessage = 'POLE-mutated: prognosi eccellente indipendentemente da p53';
  } else if (data.mmrStatus === 'deficient') {
    wtSubtype = 'mmrd';
    wtMessage = 'MMR-deficient: prognosi buona con p53-WT (peggiore se fosse p53-abn)';
  } else if (data.grade === 'high' && data.morphPleomorphism) {
    wtSubtype = 'highgrade';
    wtMessage = 'High-grade con pleomorfismo: considerare molecular testing (rischio p53-abn copy-neutral)';
  }
  
  // 7. MOSAIC WILD-TYPE (classic pattern)
  if (data.distribution === 'mosaic' && metrics.percAny >= 20 && metrics.percAny <= 80) {
    return {
      type: 'wt',
      title: 'Wild-type (pattern a mosaico tipico)',
      reason: 'Distribuzione eterogenea caratteristica del wild-type',
      confidence: 'Alta',
      action: wtSubtype === 'standard' ? 'Nessun testing molecolare necessario' : 'Contestualizzare con status molecolare',
      molecular: wtMessage || 'Funzione p53 normale',
      subtype: wtSubtype
    };
  }
  
  // 8. WILD-TYPE - OTHER PATTERNS
  if (metrics.percAny < 20) {
    return {
      type: 'wt',
      title: 'Wild-type (positivit√† molto bassa)',
      reason: `Solo ${metrics.percAny.toFixed(0)}% nuclei positivi`,
      confidence: 'Moderata',
      action: 'Considerare sampling bias se biopsia, o artefatti tecnici',
      molecular: wtMessage || 'Compatibile con funzione normale, ma cautela su sampling',
      subtype: wtSubtype
    };
  }
  
  return {
    type: 'wt',
    title: 'Wild-type',
    reason: 'Nessun criterio per over-expression o pattern aberrante soddisfatto',
    confidence: qualityIssues.length > 0 ? 'Moderata' : 'Alta',
    action: wtSubtype === 'standard' ? 'No further molecular testing needed' : 'Contestualizzare',
    molecular: wtMessage || 'Funzione p53 normale',
    subtype: wtSubtype
  };
}

function updateOutput(interpretation, metrics, data, qualityIssues) {
  // Update metrics display
  let metricsHTML = `
    ${createMetric(metrics.percAny.toFixed(0), 'Positivi totali', '%')}
    ${createMetric(metrics.percStrong.toFixed(0), 'Positivi forti', '%')}
    ${createMetric(metrics.hScore.toFixed(0), 'H-score', '')}
  `;
  
  if (data.caseId) {
    metricsHTML += `${createMetric(data.caseId, 'ID caso', '')}`;
  }
  
  document.getElementById('metricsSection').innerHTML = metricsHTML;
  
  // Update main result
  const alertType = interpretation.type === 'ni' ? 'danger' : 
                   interpretation.type === 'oe' || interpretation.type === 'null' || interpretation.type === 'cyto' ? 'warning' : 'success';
  
  let mainHTML = `
    ${createBadge(interpretation.title, interpretation.type)}
    <div style="margin-top: 12px; font-size: 0.95rem; text-align: left;">
      <strong>Motivazione:</strong> ${interpretation.reason}<br>
      <strong>Confidenza:</strong> ${interpretation.confidence}<br>
      <strong>Azione:</strong> ${interpretation.action}
    </div>
  `;
  
  if (interpretation.poleWarning) {
    mainHTML += interpretation.poleWarning;
  }
  
  document.getElementById('mainResult').innerHTML = mainHTML;
  document.getElementById('mainResult').className = `alert alert-${alertType}`;
  
  // Detailed analysis
  let detailHTML = '<h3>Analisi dettagliata</h3><div class="criteria-list">';
  
  detailHTML += `<p><strong>Organo:</strong> ${data.tumorType.charAt(0).toUpperCase() + data.tumorType.slice(1)} ‚Ä¢ <strong>Campione:</strong> ${data.specimenType}</p>`;
  
  if (data.mmrStatus !== 'unknown' || data.poleStatus !== 'unknown') {
    detailHTML += `<p><strong>Contesto molecolare:</strong> `;
    if (data.mmrStatus !== 'unknown') detailHTML += `MMR ${data.mmrStatus} `;
    if (data.poleStatus !== 'unknown') detailHTML += `POLE ${data.poleStatus}`;
    detailHTML += `</p>`;
  }
  
  detailHTML += `<p><strong>Correlazione molecolare:</strong> ${interpretation.molecular}</p>`;
  
  if (qualityIssues.length > 0) {
    detailHTML += `<div class="alert alert-warning" style="margin-top:10px;"><strong>‚ö†Ô∏è Limitazioni tecniche:</strong><ul>`;
    qualityIssues.forEach(issue => detailHTML += `<li>${issue}</li>`);
    detailHTML += `</ul></div>`;
  }
  
  // Morphology correlation
  const morphFlags = [];
  if (data.morphPleomorphism) morphFlags.push('Pleomorfismo marcato');
  if (data.morphTILs) morphFlags.push('TILs aumentati');
  if (data.morphNecrosis) morphFlags.push('Necrosi estesa');
  if (data.morphSerous) morphFlags.push('Architettura high-grade');
  
  if (morphFlags.length > 0) {
    detailHTML += `<p><strong>Morfologia correlativa:</strong> ${morphFlags.join(', ')}</p>`;
  }
  
  if (data.additionalNotes.trim()) {
    detailHTML += `<p><strong>Note:</strong> ${data.additionalNotes}</p>`;
  }
  
  detailHTML += '</div>';
  document.getElementById('detailedAnalysis').innerHTML = detailHTML;
  
  // Recommendations
  let recHTML = '<h3>Raccomandazioni cliniche</h3>';
  
  if (interpretation.type === 'ni') {
    recHTML += `<div class="alert alert-danger"><strong>üî¥ NON REFERTARE</strong><br>${interpretation.action}</div>`;
  } else if (interpretation.type === 'oe' || interpretation.type === 'null' || interpretation.type === 'cyto') {
    recHTML += `<div class="alert alert-warning"><strong>Pattern p53-aberrante confermato</strong><br>`;
    recHTML += `Procedere con refertazione. `;
    if (data.specimenType === 'biopsia') {
      recHTML += `Su biopsia: pattern confermato ma considerare sampling per estensione.`;
    }
    recHTML += `</div>`;
  } else {
    // Wild-type specific recommendations
    if (interpretation.subtype === 'pole') {
      recHTML += `<div class="alert alert-success"><strong>‚úì Wild-type in contesto POLE-mutated</strong><br>Prognosi eccellente. No molecular testing necessario.</div>`;
    } else if (interpretation.subtype === 'mmrd') {
      recHTML += `<div class="alert alert-info"><strong>Wild-type in contesto MMR-deficient</strong><br>Prognosi favorevole (vs p53-abn in MMRd). Follow-up standard.</div>`;
    } else if (interpretation.subtype === 'highgrade') {
      recHTML += `<div class="alert alert-warning"><strong>‚ö†Ô∏è Wild-type ma morfologia high-grade</strong><br>Considerare NGS per escludere p53 copy-neutral LOH o mutazioni non rilevabili con IHC.</div>`;
    } else {
      recHTML += `<div class="alert alert-success"><strong>‚úì Pattern wild-type confermato</strong><br>`;
      recHTML += interpretation.confidence === 'Alta' ? 
        'Molecular testing non necessario salvo indicazioni cliniche specifiche.' :
        'Pattern wild-type ma con limitazioni (vedi sopra). Molecular testing a discrezione clinica.';
      recHTML += `</div>`;
    }
  }
  
  document.getElementById('recommendations').innerHTML = recHTML;
  
  // Generate report text
  generateReportText(interpretation, metrics, data);
}

function generateReportText(interpretation, metrics, data) {
  const thresholds = THRESHOLDS[data.tumorType];
  
  let report = `p53 IMMUNOISTOCHIMICA - INTERPRETAZIONE PATTERN-BASED (v2.0)\n`;
  report += `${'='.repeat(60)}\n\n`;
  
  if (data.caseId) report += `Caso: ${data.caseId}\n`;
  report += `Organo: ${data.tumorType}\n`;
  report += `Tipo campione: ${data.specimenType}\n\n`;
  
  report += `QUANTIFICAZIONE:\n`;
  report += `- Nuclei negativi (0): ${data.perc0}%\n`;
  report += `- Nuclei deboli (1+): ${data.perc1}%\n`;
  report += `- Nuclei moderati (2+): ${data.perc2}%\n`;
  report += `- Nuclei forti (3+): ${data.perc3}%\n`;
  report += `- H-score: ${metrics.hScore.toFixed(0)}\n`;
  report += `- Distribuzione: ${data.distribution}\n\n`;
  
  report += `PATTERN: ${interpretation.title.toUpperCase()}\n\n`;
  
  report += `INTERPRETAZIONE:\n`;
  report += `${interpretation.reason}\n`;
  report += `Confidenza interpretativa: ${interpretation.confidence}\n\n`;
  
  if (interpretation.type === 'oe') {
    report += `Criteri over-expression soddisfatti per ${data.tumorType}:\n`;
    report += `Soglie: ‚â•${thresholds.strong}% forte, H-score ‚â•${thresholds.hscore}\n\n`;
  }
  
  report += `CORRELAZIONE MOLECOLARE:\n${interpretation.molecular}\n\n`;
  
  report += `CONCLUSIONE:\n`;
  if (interpretation.type === 'oe' || interpretation.type === 'null' || interpretation.type === 'cyto') {
    report += `Pattern p53-ABERRANTE (equivalente a mutazione TP53).\n`;
  } else if (interpretation.type === 'wt') {
    report += `Pattern p53-WILD TYPE (funzione normale).\n`;
  } else {
    report += `Pattern NON INTERPRETABILE - ripetere test.\n`;
  }
  
  report += `\n${interpretation.action}\n`;
  
  if (data.additionalNotes.trim()) {
    report += `\nNote: ${data.additionalNotes}\n`;
  }
  
  report += `\nMetodologia: Pattern-based interpretation (Singh 2020, K√∂bel 2016/2019)\n`;
  report += `v2.0 FIXED: Soglie ovaio corrette (80% strong), POLE context flag, H-score display\n`;
  
  document.getElementById('reportText').textContent = report;
  document.getElementById('reportSection').style.display = 'block';
}

// ============ HISTORY MANAGEMENT ============
function saveToHistory() {
  const data = {
    timestamp: new Date().toISOString(),
    caseId: document.getElementById('caseId').value || 'Senza ID',
    tumorType: document.getElementById('tumorType').value,
    specimenType: document.getElementById('specimenType').value,
    perc0: document.getElementById('perc0').value,
    perc1: document.getElementById('perc1').value,
    perc2: document.getElementById('perc2').value,
    perc3: document.getElementById('perc3').value,
    distribution: document.getElementById('distribution').value,
    localization: document.getElementById('localization').value
  };
  
  let history = JSON.parse(localStorage.getItem('p53History') || '[]');
  history.unshift(data);
  history = history.slice(0, 5);
  localStorage.setItem('p53History', JSON.stringify(history));
  
  loadHistory();
  alert('‚úì Salvato in cronologia');
}

function loadHistory() {
  const history = JSON.parse(localStorage.getItem('p53History') || '[]');
  const historyList = document.getElementById('historyList');
  
  if (history.length === 0) {
    historyList.innerHTML = '<p class="hint">Nessun caso salvato</p>';
    return;
  }
  
  historyList.innerHTML = history.map((item, idx) => {
    const date = new Date(item.timestamp);
    return `
      <div class="history-item" onclick="loadHistoryItem(${idx})">
        <div class="history-item-header">${item.caseId} - ${item.tumorType}</div>
        <div class="history-item-detail">${date.toLocaleDateString('it-IT')} ${date.toLocaleTimeString('it-IT', {hour: '2-digit', minute:'2-digit'})} | ${item.specimenType}</div>
      </div>
    `;
  }).join('');
}

function loadHistoryItem(index) {
  const history = JSON.parse(localStorage.getItem('p53History') || '[]');
  const item = history[index];
  
  if (!item) return;
  
  document.getElementById('caseId').value = item.caseId === 'Senza ID' ? '' : item.caseId;
  document.getElementById('tumorType').value = item.tumorType;
  document.getElementById('specimenType').value = item.specimenType;
  document.getElementById('perc0').value = item.perc0;
  document.getElementById('perc1').value = item.perc1;
  document.getElementById('perc2').value = item.perc2;
  document.getElementById('perc3').value = item.perc3;
  document.getElementById('distribution').value = item.distribution;
  document.getElementById('localization').value = item.localization;
  
  updatePercSum();
  toggleCollapse('historyContent');
}

function clearHistory() {
  if (confirm('Cancellare tutta la cronologia?')) {
    localStorage.removeItem('p53History');
    loadHistory();
  }
}

// ============ EVENT LISTENERS ============
document.getElementById('calculateBtn').addEventListener('click', calculateInterpretation);

document.getElementById('resetBtn').addEventListener('click', function() {
  document.querySelectorAll('input, select, textarea').forEach(element => {
    if (element.type === 'number') {
      element.value = '0';
    } else if (element.type === 'checkbox') {
      element.checked = false;
    } else if (element.tagName === 'SELECT') {
      element.selectedIndex = 0;
    } else {
      element.value = '';
    }
  });
  document.getElementById('outputSection').classList.remove('show');
  updatePercSum();
});

document.getElementById('saveHistoryBtn').addEventListener('click', saveToHistory);

document.getElementById('copyReportBtn').addEventListener('click', function() {
  const reportText = document.getElementById('reportText').textContent;
  navigator.clipboard.writeText(reportText).then(() => {
    const btn = document.getElementById('copyReportBtn');
    const originalText = btn.textContent;
    btn.textContent = '‚úì Copiato!';
    setTimeout(() => btn.textContent = originalText, 2000);
  });
});

// Auto-update percentage sum
['perc0', 'perc1', 'perc2', 'perc3'].forEach(id => {
  document.getElementById(id).addEventListener('input', updatePercSum);
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
  if (e.ctrlKey && e.key === 'Enter') {
    e.preventDefault();
    calculateInterpretation();
  } else if (e.ctrlKey && e.key === 'r') {
    e.preventDefault();
    document.getElementById('resetBtn').click();
  }
});

// Show keyboard hints on first load
window.addEventListener('load', function() {
  const hint = document.getElementById('keyboardHint');
  hint.classList.add('show');
  setTimeout(() => hint.classList.remove('show'), 3000);
  
  loadHistory();
  updatePercSum();
});
</script>
</body>
</html>
