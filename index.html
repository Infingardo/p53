<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>p53 IHC Helper - Quando richiederla e come interpretarla v2.1</title>
<style>
  :root { 
    --pad: 16px; --radius: 12px; --maxw: 900px; 
    --primary: #1e40af; --success: #059669; --warning: #d97706; 
    --danger: #dc2626; --info: #0891b2; --gray: #6b7280;
  }
  
  * { box-sizing: border-box; }
  
  body { 
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
    margin: 0; background: #f8fafc; color: #1e293b; line-height: 1.6; 
  }
  
  .wrap { 
    max-width: var(--maxw); margin: 20px auto 60px; 
    padding: 0 var(--pad); 
  }
  
  .card { 
    background: #fff; border-radius: var(--radius); 
    padding: var(--pad); box-shadow: 0 4px 16px rgba(0,0,0,0.08); 
    margin-bottom: 20px; border: 1px solid #e2e8f0; 
  }
  
  .card-header { 
    border-bottom: 2px solid #e2e8f0; margin-bottom: var(--pad); 
    padding-bottom: 12px; 
  }
  
  h1 { 
    font-size: 1.6rem; margin: 0; color: var(--primary); 
    font-weight: 700; 
  }
  
  h2 { 
    font-size: 1.2rem; margin: 0 0 16px; color: #374151; 
    font-weight: 600; 
  }
  
  h3 { 
    font-size: 1rem; margin: 16px 0 8px; color: #4b5563; 
    font-weight: 600; 
  }
  
  .subtitle { 
    font-size: 0.9rem; color: var(--gray); margin-top: 8px; 
  }
  
  .tabs { 
    display: flex; gap: 8px; margin: 16px 0; border-bottom: 2px solid #e2e8f0; 
    flex-wrap: wrap;
  }
  
  .tab { 
    padding: 12px 20px; border: 0; background: transparent; 
    cursor: pointer; font-weight: 600; font-size: 0.95rem; 
    color: var(--gray); border-bottom: 3px solid transparent; 
    transition: all 0.2s; 
  }
  
  .tab:hover { color: var(--primary); }
  
  .tab.active { 
    color: var(--primary); border-bottom-color: var(--primary); 
  }
  
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  
  .form-group { margin-bottom: 16px; }
  
  label { 
    display: block; font-size: 0.9rem; font-weight: 500; 
    margin-bottom: 6px; color: #374151; 
  }
  
  input[type="number"], input[type="range"], select, textarea { 
    width: 100%; padding: 10px 12px; border: 1.5px solid #d1d5db; 
    border-radius: 8px; font-size: 0.95rem; transition: border-color 0.2s; 
  }
  
  input:focus, select:focus, textarea:focus { 
    outline: none; border-color: var(--primary); 
    box-shadow: 0 0 0 3px rgba(30,64,175,0.1); 
  }
  
  input[type="radio"], input[type="checkbox"] { 
    width: auto; margin-right: 8px; 
  }
  
  .radio-group label, .checkbox-group label { 
    display: flex; align-items: center; margin: 8px 0; 
    font-weight: 400; cursor: pointer; 
  }
  
  .hint { 
    font-size: 0.82rem; color: var(--gray); margin-top: 4px; 
  }
  
  .hint.warning { color: var(--warning); font-weight: 500; }
  
  .btn { 
    display: inline-block; padding: 12px 24px; border-radius: 8px; 
    border: 0; background: var(--primary); color: #fff; 
    font-weight: 600; cursor: pointer; font-size: 0.95rem; 
    transition: all 0.2s; margin-right: 8px; margin-bottom: 8px; 
  }
  
  .btn:hover { 
    background: #1e3a8a; transform: translateY(-1px); 
    box-shadow: 0 4px 12px rgba(30,64,175,0.3); 
  }
  
  .btn-secondary { background: var(--gray); }
  .btn-secondary:hover { background: #4b5563; }
  
  .btn-small { padding: 8px 14px; font-size: 0.85rem; }
  
  .badge { 
    display: inline-block; padding: 8px 14px; border-radius: 20px; 
    font-size: 0.9rem; font-weight: 600; border: 2px solid; 
  }
  
  .badge-yes { 
    background: #d1fae5; color: #065f46; border-color: #a7f3d0; 
  }
  
  .badge-maybe { 
    background: #fef3c7; color: #92400e; border-color: #fde68a; 
  }
  
  .badge-no { 
    background: #fee2e2; color: #991b1b; border-color: #fecaca; 
  }
  
  .badge-wt { 
    background: #d1fae5; color: #065f46; border-color: #a7f3d0; 
  }
  
  .badge-mild { 
    background: #fef3c7; color: #92400e; border-color: #fde68a; 
  }
  
  .badge-oe { 
    background: #fed7aa; color: #9a3412; border-color: #fdba74; 
  }
  
  .badge-null { 
    background: #fee2e2; color: #991b1b; border-color: #fecaca; 
  }
  
  .badge-ni { 
    background: #f3f4f6; color: #374151; border-color: #d1d5db; 
  }
  
  .alert { 
    padding: 14px 16px; border-radius: 8px; margin: 12px 0; 
    border-left: 4px solid; 
  }
  
  .alert-success { 
    background: #f0fdf4; border-color: var(--success); color: #15803d; 
  }
  
  .alert-warning { 
    background: #fffbeb; border-color: var(--warning); color: #a16207; 
  }
  
  .alert-danger { 
    background: #fef2f2; border-color: var(--danger); color: #b91c1c; 
  }
  
  .alert-info { 
    background: #f0f9ff; border-color: var(--info); color: #0c4a6e; 
  }
  
  .result-box { 
    background: #f8fafc; border: 2px solid #e2e8f0; 
    border-radius: var(--radius); padding: 20px; margin: 16px 0; 
  }
  
  .cutoff-visual { 
    margin: 20px 0; padding: 16px; background: #f8fafc; 
    border-radius: 8px; border: 1px solid #e2e8f0; 
  }
  
  .cutoff-bar { 
    position: relative; height: 40px; 
    background: linear-gradient(to right, #d1fae5 0%, #d1fae5 15%, #fef3c7 15%, #fef3c7 65%, #fed7aa 65%, #fed7aa 100%); 
    border-radius: 8px; margin: 12px 0; border: 2px solid #cbd5e1; 
  }
  
  .cutoff-marker { 
    position: absolute; top: -8px; width: 3px; height: 56px; 
    background: var(--danger); 
  }
  
  .cutoff-marker::after { 
    content: '‚ñº'; position: absolute; top: -20px; left: -6px; 
    font-size: 1.2rem; color: var(--danger); 
  }
  
  .cutoff-labels { 
    display: flex; justify-content: space-between; font-size: 0.85rem; 
    color: var(--gray); margin-top: 8px; 
  }
  
  .report-box { 
    background: #1e293b; color: #e2e8f0; padding: 16px; 
    border-radius: 8px; font-family: 'Courier New', monospace; 
    font-size: 0.85rem; white-space: pre-wrap; margin: 16px 0; 
    max-height: 400px; overflow-y: auto; 
  }
  
  .confidence { 
    display: inline-flex; align-items: center; gap: 4px; 
    font-size: 0.9rem; margin: 8px 0; 
  }
  
  .star { color: #fbbf24; }
  
  .reference-table { 
    width: 100%; border-collapse: collapse; margin: 16px 0; 
    font-size: 0.9rem; 
  }
  
  .reference-table th, .reference-table td { 
    border: 1px solid #d1d5db; padding: 10px; text-align: left; 
  }
  
  .reference-table th { 
    background: #f8fafc; font-weight: 600; color: #374151; 
  }
  
  .reference-table tr:nth-child(even) { background: #f9fafb; }
  
  .output-section { display: none; }
  .output-section.show { display: block; }
  
  .trap-box {
    background: #fff; border-left: 4px solid var(--danger);
    padding: 12px 16px; margin: 12px 0; border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }
  
  .trap-title {
    font-weight: 600; color: var(--danger); margin-bottom: 6px;
  }
  
  .footer {
    text-align: center; padding: 30px 20px; color: var(--gray); 
    font-size: 0.85rem; border-top: 2px solid #e2e8f0; 
    margin-top: 40px; background: #f8fafc;
  }
  
  .footer strong { color: var(--primary); }
  
  @media (max-width: 768px) {
    .wrap { padding: 0 12px; }
    .tabs { flex-direction: column; }
    .tab { border-bottom: 1px solid #e2e8f0; border-left: 3px solid transparent; }
    .tab.active { border-left-color: var(--primary); border-bottom-color: #e2e8f0; }
    h1 { font-size: 1.3rem; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <div class="card">
      <div class="card-header">
        <h1>p53 IHC Helper - Quando richiederla e come interpretarla</h1>
        <p class="subtitle">Tool diagnostico per patologi ‚Ä¢ v2.1.1 "p53 for dummies edition" con Ki67</p>
      </div>
      <div class="alert alert-info">
        <strong>Uso:</strong> Supporto decisionale per richiesta p53 in displasia epiteliale + interpretazione risultati con cutoff organo-specifici validati. Basato su <strong>"p53 for dummies"</strong> (<a href="https://github.com/Infingardo/p53/blob/main/p53%20for%20dummies.pdf" target="_blank" style="color: var(--primary);">Bianchi 2025</a>) e letteratura validata (WHO 2022, Fassan 2014, K√∂bel 2019).
      </div>
      <div class="alert alert-warning">
        <strong>‚ö†Ô∏è Disclaimer validazione:</strong> Tool basato su revisione sistematica della letteratura e best practices pubblicate (Fassan 2014, K√∂bel 2019, Osakabe 2025, WHO 2022). Non validato prospetticamente su casistica locale. La diagnosi finale rimane responsabilit√† del patologo con correlazione clinico-patologica completa.
      </div>
    </div>

    <!-- Tabs -->
    <div class="card">
      <div class="tabs">
        <button class="tab active" data-tab="decision" onclick="switchTab('decision', this)">ü§î Devo fare la p53?</button>
        <button class="tab" data-tab="interpret" onclick="switchTab('interpret', this)">üî¨ Interpreto il risultato</button>
        <button class="tab" data-tab="reference" onclick="switchTab('reference', this)">üìö Reference rapido</button>
      </div>
    </div>

    <!-- TAB 1: DECISION -->
    <div id="tab-decision" class="tab-content active">
      <div class="card">
        <h2>ü§î Devo fare la p53?</h2>
        <p class="hint">Inserisci il tuo scenario diagnostico per valutare l'utilit√† della p53 IHC</p>
        
        <div class="form-group">
          <label>Organo</label>
          <select id="dec-organ" onchange="updateDoubtOptions()">
            <option value="gastric">Stomaco (displasia gastrica)</option>
            <option value="colon">Colon (displasia colonica non-IBD)</option>
            <option value="colon-ibd">Colon IBD (colite ulcerosa/Crohn)</option>
            <option value="bladder">Vescica (displasia uroteliale)</option>
            <option value="esophagus">Esofago (Barrett's)</option>
            <option value="larynx">Laringe (displasia laringea)</option>
          </select>
        </div>

        <div class="form-group">
          <label>Il tuo dubbio diagnostico</label>
          <select id="dec-doubt">
            <option value="reactive-vs-lgd">Reattivo/rigenerativo vs Displasia (LGD)</option>
            <option value="lgd-vs-hgd">LGD vs HGD</option>
            <option value="hgd-vs-cancer">HGD vs Carcinoma</option>
            <!-- "indefinite" option will be added dynamically for colon-ibd only -->
          </select>
        </div>

        <div class="form-group">
          <label>Citologia nucleare che vedi al microscopio</label>
          <div class="radio-group">
            <label><input type="radio" name="cytology" value="normal" /> Nuclei normali (solo affollamento/rigenerazione)</label>
            <label><input type="radio" name="cytology" value="borderline" checked /> Nuclei borderline (qualche atipia, incerto)</label>
            <label><input type="radio" name="cytology" value="atypia" /> Nuclei francamente atipici (pleomorfi, ipercromatici)</label>
          </div>
        </div>

        <div class="form-group">
          <label>Contesto clinico (seleziona se presente)</label>
          <div class="checkbox-group">
            <label><input type="checkbox" id="ctx-inflammation" /> Infiammazione attiva marcata</label>
            <label><input type="checkbox" id="ctx-ulcer" /> Ulcerazione presente</label>
            <label><input type="checkbox" id="ctx-hpylori" /> H. pylori attivo (gastrico)</label>
            <label><input type="checkbox" id="ctx-ibd" /> IBD attiva (colon)</label>
            <label><input type="checkbox" id="ctx-posttreat" /> Post-terapia/radioterapia</label>
          </div>
        </div>

        <button class="btn" onclick="analyzeDecision()">üéØ Valuta utilit√† p53</button>
        <button class="btn btn-secondary" onclick="resetDecision()">Reset</button>
      </div>

      <div id="decision-output" class="output-section">
        <div class="card">
          <h2>Risultato valutazione</h2>
          <div id="decision-result"></div>
        </div>
      </div>
    </div>

    <!-- TAB 2: INTERPRET -->
    <div id="tab-interpret" class="tab-content">
      <div class="card">
        <h2>üî¨ Interpreto il risultato p53</h2>
        <p class="hint">Inserisci i dati della colorazione p53 per interpretazione pattern-based</p>
        
        <div class="form-group">
          <label>Organo</label>
          <select id="int-organ">
            <option value="gastric">Stomaco</option>
            <option value="colon">Colon (non-IBD)</option>
            <option value="colon-ibd">Colon IBD</option>
            <option value="bladder">Vescica</option>
            <option value="esophagus">Esofago</option>
            <option value="larynx">Laringe</option>
          </select>
        </div>

        <div class="form-group">
          <label>% nuclei positivi (qualsiasi intensit√†)</label>
          <input type="range" id="int-percent" min="0" max="100" value="50" oninput="updatePercentDisplay(); validateSpecialPatterns()" />
          <div style="text-align: center; font-size: 1.2rem; font-weight: 700; color: var(--primary); margin-top: 8px;">
            <span id="percent-display">50</span>%
          </div>
        </div>

        <div class="form-group">
          <label>Intensit√† prevalente dei nuclei positivi</label>
          <select id="int-intensity">
            <option value="1">1+ debole</option>
            <option value="2" selected>2+ moderato</option>
            <option value="3">3+ forte</option>
            <option value="mixed">Misto (1+/2+/3+)</option>
          </select>
        </div>

        <div class="form-group">
          <label>Distribuzione della positivit√†</label>
          <select id="int-distribution">
            <option value="mosaic">Mosaico sparse (hallmark wild-type)</option>
            <option value="focal">Focale (alcune aree positive)</option>
            <option value="diffuse" selected>Diffuso uniforme (tutta la lesione)</option>
          </select>
        </div>

        <div class="form-group">
          <label>Controllo interno (cellule normali circostanti)</label>
          <select id="int-control">
            <option value="strong" selected>Presente forte</option>
            <option value="weak">Presente debole</option>
            <option value="absent">Assente</option>
          </select>
        </div>

        <div class="form-group">
          <label>Pattern speciale (opzionale)</label>
          <select id="int-special" onchange="validateSpecialPatterns()">
            <option value="none" selected>Nessuno</option>
            <option value="null">Null (0% nuclei con controllo forte)</option>
            <option value="cytoplasmic">Citoplasmatico puro (nuclei negativi)</option>
            <option value="rim">Rim-like periferico</option>
          </select>
          <div id="special-warning" class="hint warning" style="display: none;"></div>
        </div>

        <h3>Ki67 (opzionale, aiuta se p53 zona grigia)</h3>
        <div class="form-group">
          <label>Ki67 proliferazione</label>
          <select id="int-ki67">
            <option value="unknown">Non eseguito</option>
            <option value="basal">Basale (<10%)}}</option>
            <option value="moderate">Moderato (10-30%, esteso ai 2/3)</option>
            <option value="high">Alto (>30%, esteso/full-thickness)</option>
          </select>
          <div class="hint">
            üí° <strong>Gastrico/Colon:</strong> >30% esteso ai 2/3 superiori favorisce displasia (criterio: <em>distribuzione</em> non solo %) | <strong>Vescica:</strong> full-thickness favorisce displasia | <strong>Uso principale:</strong> disambigua p53 zona grigia (10-60%)
          </div>
        </div>

        <button class="btn" onclick="analyzeInterpretation()">üìä Analizza pattern p53</button>
        <button class="btn btn-secondary" onclick="resetInterpretation()">Reset</button>
      </div>

      <div id="interpret-output" class="output-section">
        <div class="card">
          <h2>Interpretazione p53</h2>
          <div id="interpret-result"></div>
        </div>
      </div>
    </div>

    <!-- TAB 3: REFERENCE -->
    <div id="tab-reference" class="tab-content">
      <div class="card">
        <h2>üìö Reference rapido</h2>
        
        <h3>Cutoff p53 per organo (displasia epiteliale)</h3>
        <table class="reference-table">
          <thead>
            <tr>
              <th>Organo</th>
              <th>Wild-type</th>
              <th>Zona grigia</th>
              <th>Over-expression</th>
              <th>Note</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Stomaco</strong></td>
              <td>&lt;10%</td>
              <td>10-60%</td>
              <td><strong>&gt;60%</strong> diffuso</td>
              <td>Fassan 2014, WHO 2022</td>
            </tr>
            <tr>
              <td><strong>Colon</strong></td>
              <td>&lt;20%</td>
              <td>20-60%</td>
              <td><strong>&gt;60%</strong> diffuso</td>
              <td>‚ö†Ô∏è IBD: 20-50% pu√≤ essere stress</td>
            </tr>
            <tr>
              <td><strong>Vescica</strong></td>
              <td>&lt;10%</td>
              <td>10-50%</td>
              <td><strong>&gt;50%</strong> diffuso</td>
              <td>Threshold pi√π basso, OE frequente in HGD</td>
            </tr>
            <tr>
              <td><strong>Esofago</strong></td>
              <td>&lt;10%</td>
              <td>10-60%</td>
              <td><strong>&gt;60%</strong> diffuso</td>
              <td>Barrett's dysplasia</td>
            </tr>
            <tr>
              <td><strong>Laringe</strong></td>
              <td>&lt;10%</td>
              <td>10-50%</td>
              <td><strong>&gt;50%</strong> full-thickness</td>
              <td>Basale vs full-thickness rilevante</td>
            </tr>
          </tbody>
        </table>

        <h3>Ki67 - Cutoff per organo (supportivo se p53 zona grigia)</h3>
        <table class="reference-table">
          <thead>
            <tr>
              <th>Organo</th>
              <th>Normale/Reattivo</th>
              <th>LGD</th>
              <th>HGD</th>
              <th>Criterio chiave</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Stomaco</strong></td>
              <td>&lt;10% basale</td>
              <td>10-30%</td>
              <td><strong>&gt;30%</strong> esteso ai 2/3 superiori</td>
              <td><strong>DISTRIBUZIONE</strong> pi√π che %</td>
            </tr>
            <tr>
              <td><strong>Colon</strong></td>
              <td>Basale (cripta profonda)</td>
              <td>Esteso ai 2/3 medi</td>
              <td><strong>Full-thickness</strong> diffuso</td>
              <td><strong>PATTERN</strong> (basale ‚Üí superficiale)</td>
            </tr>
            <tr>
              <td><strong>Vescica</strong></td>
              <td>Superficiale</td>
              <td>‚Äî</td>
              <td><strong>Full-thickness</strong></td>
              <td>Maturazione persa</td>
            </tr>
            <tr>
              <td><strong>Esofago</strong></td>
              <td>Basale</td>
              <td>Basale-medio</td>
              <td><strong>Full-thickness</strong></td>
              <td>Barrett's dysplasia</td>
            </tr>
            <tr>
              <td><strong>Laringe</strong></td>
              <td>Basale</td>
              <td>Basale-medio</td>
              <td><strong>Full-thickness</strong></td>
              <td>Maturazione pattern</td>
            </tr>
          </tbody>
        </table>
        <p class="hint"><strong>‚ö†Ô∏è Nota Ki67:</strong> Per displasie gastriche/coliche, il <strong>pattern di distribuzione</strong> (basale vs esteso ai 2/3 vs full-thickness) √® pi√π importante della percentuale assoluta. Fassan 2014 enfatizza "estensione ai 2/3 superficiali" come criterio qualitativo chiave.</p>

        <h3>Quando fare la p53 - Decision matrix</h3>
        <div class="alert alert-info" style="margin-bottom: 16px;">
          <strong>‚ö†Ô∏è Scope di questo tool:</strong> DISPLASIE epiteliali (stomaco, colon, vescica, esofago, laringe).<br>
          Per <strong>carcinomi sierosi</strong> (ovaio/endometrio) e <strong>gliomi IDH-wt</strong>, p53 √® sempre obbligatorio ma utilizza pattern/cutoff diversi. Vedi K√∂bel 2019 (sierosi: >95% mutati, pattern OE/null) e WHO CNS 2021 (gliomi: p53 prognostico + IDH/ATRX).
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin: 20px 0;">
          <div class="alert alert-success">
            <h4 style="margin-top: 0;">üü¢ SEMPRE indicata (fuori scope tool)</h4>
            <ul style="margin: 8px 0; padding-left: 20px;">
              <li>Carcinomi sierosi (ovaio/endometrio) - >95% mutati</li>
              <li>Gliomi IDH-wt alto grado (prognostico)</li>
            </ul>
          </div>
          
          <div class="alert alert-success">
            <h4 style="margin-top: 0;">üü¢ SEMPRE indicata (in scope)</h4>
            <ul style="margin: 8px 0; padding-left: 20px;">
              <li>Displasia Barrett HGD o dubbio</li>
              <li>Vescica HGD dubbio vs carcinoma</li>
            </ul>
          </div>
          
          <div class="alert alert-warning">
            <h4 style="margin-top: 0;">üü° UTILE in contesto specifico (in scope)</h4>
            <ul style="margin: 8px 0; padding-left: 20px;">
              <li>Displasia gastrica borderline</li>
              <li>Vescica: displasia uroteliale vs reattivo</li>
              <li>Colon IBD: displasia vs indefinite (SE in remissione)</li>
            </ul>
          </div>
          
          <div class="alert alert-danger">
            <h4 style="margin-top: 0;">üî¥ NON indicata (quasi mai)</h4>
            <ul style="margin: 8px 0; padding-left: 20px;">
              <li>Polipi iperplastici del colon</li>
              <li>Cisti sebacee, papillomi cutanei</li>
              <li>Fibromi uterini</li>
              <li>Lesioni benigne di cute/annessi</li>
              <li>Casi dove il risultato non cambia la diagnosi</li>
            </ul>
          </div>
        </div>

        <h3>‚ö†Ô∏è Le 7 Trappole della p53 (da evitare)</h3>
        <p class="hint" style="margin-bottom: 12px;"><em>Da "p53 for dummies" (<a href="https://github.com/Infingardo/p53/blob/main/p53%20for%20dummies.pdf" target="_blank" style="color: var(--primary);">Bianchi 2025</a>, Cap. 8)</em></p>
        
        <div class="trap-box">
          <div class="trap-title">1. Falso overexpressed</div>
          <strong>Scenario:</strong> Flogosi cronica, rigenerazione tissutale<br>
          <strong>Pattern:</strong> Positivit√† diffusa ma eterogenea in intensit√†<br>
          <strong>Soluzione:</strong> Valuta contesto istologico - se c'√® infiammazione, sospetta falso positivo
        </div>

        <div class="trap-box">
          <div class="trap-title">2. Null-type senza controlli</div>
          <strong>Scenario:</strong> Tutto negativo, nessun controllo interno<br>
          <strong>Errore:</strong> Interpretare come pattern null<br>
          <strong>Soluzione:</strong> <strong>RIPETERE</strong> la colorazione o dichiarare non valutabile
        </div>

        <div class="trap-box">
          <div class="trap-title">3. Rigenerazione post-chemio</div>
          <strong>Scenario:</strong> Epitelio in rigenerazione dopo trattamento<br>
          <strong>Pattern:</strong> Overexpression nelle cellule riparative<br>
          <strong>Soluzione:</strong> Data la biopsia rispetto ai trattamenti
        </div>

        <div class="trap-box">
          <div class="trap-title">4. Pattern mosaico (artefatti)</div>
          <strong>Scenario:</strong> Alternanza aree positive/negative<br>
          <strong>Interpretazione:</strong> Spesso wild-type con artefatti di fissazione<br>
          <strong>Soluzione:</strong> Concentrati sulle aree meglio conservate
        </div>

        <div class="trap-box">
          <div class="trap-title">5. Cellule apoptotiche</div>
          <strong>Scenario:</strong> Nuclei in apoptosi spesso p53-positivi<br>
          <strong>Pattern:</strong> Positivit√† in cellule picnotiche<br>
          <strong>Soluzione:</strong> <strong>NON contarle</strong> nella valutazione
        </div>

        <div class="trap-box">
          <div class="trap-title">6. Clone anticorpale sbagliato</div>
          <strong>Scenario:</strong> Cloni non validati o diluizioni inappropriate<br>
          <strong>Risultato:</strong> Pattern inconsistenti<br>
          <strong>Soluzione:</strong> Usa cloni standardizzati (DO-7, BP53-11)
        </div>

        <div class="trap-box">
          <div class="trap-title">7. Overinterpretazione borderline (30-60%)</div>
          <strong>Scenario:</strong> Pattern intermedio<br>
          <strong>Errore:</strong> Forzare l'interpretazione verso overexpressed<br>
          <strong>Soluzione:</strong> Referta come "pattern indeterminato", considera NGS
        </div>

        <h3>Pattern recognition rapido</h3>
        <div class="alert alert-success">
          <strong>üü¢ Wild-type (normale)</strong><br>
          ‚Ä¢ Distribuzione: mosaico, eterogenea, sparse<br>
          ‚Ä¢ %: &lt;10-20% (organo-dipendente)<br>
          ‚Ä¢ Intensit√†: variabile, mix debole/moderato<br>
          ‚Ä¢ Significato: funzione p53 normale, displasia non confermata
        </div>

        <div class="alert alert-warning">
          <strong>üü° Accumulo lieve (zona grigia)</strong><br>
          ‚Ä¢ Distribuzione: focale, non uniforme<br>
          ‚Ä¢ %: 10-60% (organo-dipendente)<br>
          ‚Ä¢ Intensit√†: moderato-forte ma non diffuso<br>
          ‚Ä¢ Significato: borderline, pu√≤ essere stress cellulare O inizio displasia<br>
          ‚Ä¢ Azione: ripeti biopsia, <strong>considera Ki67</strong>
        </div>

        <div class="alert alert-danger">
          <strong>üü† Over-expression (aberrante)</strong><br>
          ‚Ä¢ Distribuzione: diffuso uniforme, denso<br>
          ‚Ä¢ %: &gt;50-60% (organo-dipendente)<br>
          ‚Ä¢ Intensit√†: prevalentemente 2+/3+ forte<br>
          ‚Ä¢ Significato: mutazione TP53 stabilizzante, displasia confermata
        </div>

        <div class="alert alert-danger">
          <strong>üî¥ Null (aberrante)</strong><br>
          ‚Ä¢ Pattern: 0% nuclei positivi + controllo interno FORTE<br>
          ‚Ä¢ Significato: mutazione inattivante TP53, displasia confermata<br>
          ‚Ä¢ ‚ö†Ô∏è Se controllo debole/assente ‚Üí RIPETERE
        </div>

        <div class="alert alert-danger">
          <strong>üü£ Citoplasmatico (raro)</strong><br>
          ‚Ä¢ Pattern: Positivit√† citoplasmatica, nuclei negativi<br>
          ‚Ä¢ Meccanismo: Mutazioni NES o esoni 9-10 (sequestro citoplasmatico)<br>
          ‚Ä¢ Significato: Equivale a mutazione funzionale, prognosi simile a null<br>
          ‚Ä¢ ‚ö†Ô∏è Non confondere con: artefatti (granulari) o colorazione aspecifica<br>
          ‚Ä¢ Prevalenza: Raro nei carcinomi endometriali (~1%, K√∂bel 2019), dati scarsi per displasie
        </div>

        <h3>üî¨ Discordanza immuno/molecolare</h3>
        <div class="alert alert-warning">
          <strong>Definizione:</strong> Mancata corrispondenza tra pattern IHC e status molecolare TP53
          <br><br>
          <strong>Frequenze per sede (principalmente da studi su CARCINOMI):</strong><br>
          ‚Ä¢ Endometrio (carcinoma): 8-12% (PORTEC-3 trial, Vermij 2022)<br>
          ‚Ä¢ Colon-retto (carcinoma): 9-15% (Osakabe 2025)<br>
          ‚Ä¢ Ovaio sieroso (carcinoma): 5-10%<br>
          ‚Ä¢ Polmone (carcinoma): 12-18%<br>
          <br>
          <strong>‚ö†Ô∏è Nota CRITICA:</strong> I dati sopra derivano da carcinomi. La discordanza nelle <strong>displasie epiteliali</strong> √® probabilmente <strong>MINORE</strong> (~5% o meno), ma dati robusti scarseggiano. L'applicabilit√† ai sistemi "low mutational burden" come displasie gastriche/coliche √® limitata.
          <br><br>
          <strong>‚ö†Ô∏è Quando sospettare discordanza:</strong><br>
          ‚Ä¢ Pattern borderline + clinica non congruente<br>
          ‚Ä¢ Istotipi rari (correlazione meno studiata)<br>
          ‚Ä¢ Pazienti giovani con pattern suggestivo mutazione<br>
          ‚Ä¢ Terapie targeted (conta status molecolare reale)
          <br><br>
          <strong>‚úì Strategia:</strong> Pattern p53 dubbio + Clinica incongruente ‚Üí <strong>Considera NGS TP53</strong> per conferma molecolare
        </div>

        <h3>ü§ñ AI e p53: il futuro (2025)</h3>
        <div class="alert alert-info">
          <strong>Stato dell'arte:</strong><br>
          ‚Ä¢ Algoritmi CNN predicono p53 da H&E con accuratezza &gt;90%<br>
          ‚Ä¢ Scoring automatizzato: Visiopharm, OWKIN RlapsRisk‚Ñ¢, Ventana (FDA-approved)<br>
          ‚Ä¢ Predizione pattern da H&E (utile in coliti croniche, displasie)<br>
          ‚Ä¢ Drug discovery: AI identifica composti per riattivare mutanti specifici (es. Y220C)
          <br><br>
          <strong>Vantaggi:</strong> Standardizzazione, efficienza, oggettivit√†, riduzione variabilit√† inter-osservatore<br>
          <strong>Limitazioni:</strong> Costo implementazione, necessita training su dataset ampi, validazione clinica in corso
          <br><br>
          <strong>Futuro prossimo:</strong> Integrazione AI + dati molecolari + radiomici per stratificazione prognostica di precisione
        </div>

        <h3>Bibliografia essenziale</h3>
        <ul style="font-size: 0.9rem; line-height: 1.8;">
          <li><strong>Bianchi F.</strong> p53 for dummies. Manuale pratico per patologi. 2025 [<a href="https://github.com/Infingardo/p53/blob/main/p53%20for%20dummies.pdf" target="_blank" style="color: var(--primary);">Scarica PDF</a>] [<em>Fonte primaria per trappole interpretative, workflow pratico</em>]</li>
          <li><strong>Fassan M, et al.</strong> p53 and Ki67 expression profiles identify clinically relevant gastric dysplasia. <em>Mod Pathol</em> 2014;27:1409-1417 [<em>Cutoff gastrico, Ki67 integrazione, pattern distribuzione</em>]</li>
          <li><strong>K√∂bel M, Ronnett BM, Singh N, et al.</strong> Interpretation of P53 Immunohistochemistry in Endometrial Carcinomas: Toward Increased Reproducibility. <em>Int J Gynecol Pathol</em> 2019;38:S123-S131 [<em>Pattern-based standard; <strong>carcinomi sierosi</strong>: >95% mutati, pattern OE/null obbligatorio; citoplasmatico ~1%</em>]</li>
          <li><strong>Vermij L, et al.</strong> p53 immunohistochemistry in endometrial cancer: clinical and molecular correlates in the PORTEC-3 trial. <em>Mod Pathol</em> 2022;35:1475-1483 [<em>Correlazione IIC/molecolare in CARCINOMI endometriali, 408 casi</em>]</li>
          <li><strong>Osakabe M, et al.</strong> The pattern-based interpretation of p53 immunohistochemical expression as a surrogate marker for TP53 mutations in colorectal cancer. <em>Virchows Arch</em> 2025;486:333-341 [<em>Validazione CARCINOMI colon-retto, 91.3% concordanza</em>]</li>
          <li><strong>WHO Classification of Tumours Editorial Board.</strong> Digestive System Tumours. 5th ed. Lyon: IARC, 2019/2022 [<em>Standard classificazione displasie</em>]</li>
          <li><strong>WHO Classification of Tumours Editorial Board.</strong> Central Nervous System Tumours. 5th ed. Lyon: IARC, 2021 [<em><strong>Gliomi</strong>: p53 prognostico, integrazione con IDH/ATRX/Ki67 per grading</em>]</li>
          <li><strong>Rugge M, et al.</strong> MAPS II: Management of precancerous conditions and lesions in the stomach. <em>Gut</em> 2019;68:1743-1752 [<em>Management gastrico</em>]</li>
          <li><strong>de Haan LM, et al.</strong> Real-world routine diagnostic molecular analysis for TP53 mutational status is recommended over p53 immunohistochemistry in B-cell lymphomas. <em>Virchows Arch</em> 2024;485:643-654 [<em>Linfomi: preferire NGS</em>]</li>
          <li><strong>Ma Y, et al.</strong> Artificial intelligence in diagnostic pathology. <em>Diagn Pathol</em> 2023;18:109 [<em>AI overview</em>]</li>
          <li><strong>Kobayashi S, et al.</strong> Artificial Intelligence Program to Predict p53 Mutations in Ulcerative Colitis-Associated Cancer or Dysplasia. <em>Am J Pathol</em> 2022;192:1121-1129 [<em>Primo algoritmo AI per predizione p53 da H&E</em>]</li>
        </ul>
      </div>
    </div>

  </div>

  <!-- Footer -->
  <div class="footer">
    <p><strong>p53 IHC Helper v2.1.1 "p53 for dummies edition"</strong></p>
    <p>Tool diagnostico per patologi</p>
    <p>Sviluppato da <strong>Filippo Bianchi</strong> (SC Anatomia Patologica, ASST Fatebenefratelli-Sacco, Milano)</p>
    <p>Basato su <strong>"p53 for dummies"</strong> (<a href="https://github.com/Infingardo/p53/blob/main/p53%20for%20dummies.pdf" target="_blank" style="color: var(--primary);">Bianchi 2025</a>) e letteratura validata (WHO 2022, Fassan 2014, K√∂bel 2019, Osakabe 2025)</p>
    <p class="hint" style="margin-top: 12px;">Per supporto decisionale. La diagnosi finale rimane responsabilit√† del patologo con correlazione clinico-patologica completa.</p>
    <p class="hint"><strong>‚ö†Ô∏è Disclaimer:</strong> Tool basato su revisione sistematica della letteratura. Non validato prospetticamente su casistica locale.</p>
    <p class="hint">GitHub: <a href="https://github.com/infingardo" target="_blank" style="color: var(--primary);">infingardo</a></p>
  </div>

<script>
// ============ GLOBALS ============
const CUTOFFS = {
  gastric: { wt: 10, oe: 60 },
  colon: { wt: 20, oe: 60 },
  'colon-ibd': { wt: 20, oe: 60 },
  bladder: { wt: 10, oe: 50 },
  esophagus: { wt: 10, oe: 60 },
  larynx: { wt: 10, oe: 50 }
};

const ORGAN_NAMES = {
  gastric: 'Stomaco',
  colon: 'Colon',
  'colon-ibd': 'Colon IBD',
  bladder: 'Vescica',
  esophagus: 'Esofago',
  larynx: 'Laringe'
};

// ============ TAB SWITCHING ============
// FIX BUG #1: Passa l'elemento cliccato come parametro invece di usare event globale
function switchTab(tabName, clickedElement) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  
  // Usa l'elemento passato come parametro
  clickedElement.classList.add('active');
  document.getElementById('tab-' + tabName).classList.add('active');
}

// ============ FIX BUG #3: Opzione "Indefinite" solo per colon-ibd ============
function updateDoubtOptions() {
  const organ = document.getElementById('dec-organ').value;
  const doubtSelect = document.getElementById('dec-doubt');
  const currentValue = doubtSelect.value;
  
  // Rimuovi opzione indefinite se presente
  const indefiniteOption = doubtSelect.querySelector('option[value="indefinite"]');
  if (indefiniteOption) {
    indefiniteOption.remove();
  }
  
  // Aggiungi solo se colon-ibd
  if (organ === 'colon-ibd') {
    const option = document.createElement('option');
    option.value = 'indefinite';
    option.textContent = 'Indefinite per displasia';
    doubtSelect.appendChild(option);
  }
  
  // Se era selezionato indefinite e ora non √® pi√π disponibile, reset a default
  if (currentValue === 'indefinite' && organ !== 'colon-ibd') {
    doubtSelect.value = 'reactive-vs-lgd';
  }
}

// ============ FIX BUG #4: Validazione pattern speciali ============
function validateSpecialPatterns() {
  const special = document.getElementById('int-special').value;
  const percent = parseInt(document.getElementById('int-percent').value);
  const warningDiv = document.getElementById('special-warning');
  
  let warning = '';
  
  if (special === 'null' && percent > 5) {
    warning = '‚ö†Ô∏è Pattern NULL = 0% nuclei positivi. Hai impostato ' + percent + '%. Correggi % a 0-5% oppure seleziona "Nessuno" come pattern speciale.';
  } else if (special === 'cytoplasmic' && percent > 10) {
    warning = '‚ö†Ô∏è Pattern citoplasmatico puro = nuclei negativi (0-10%). Hai impostato ' + percent + '%. Se c\'√® positivit√† nucleare significativa, √® un pattern misto, non citoplasmatico puro.';
  }
  
  if (warning) {
    warningDiv.textContent = warning;
    warningDiv.style.display = 'block';
  } else {
    warningDiv.style.display = 'none';
  }
}

// ============ DECISION ANALYSIS ============
function analyzeDecision() {
  const organ = document.getElementById('dec-organ').value;
  const doubt = document.getElementById('dec-doubt').value;
  const cytology = document.querySelector('input[name="cytology"]:checked').value;
  const inflammation = document.getElementById('ctx-inflammation').checked;
  const ulcer = document.getElementById('ctx-ulcer').checked;
  const hpylori = document.getElementById('ctx-hpylori').checked;
  const ibd = document.getElementById('ctx-ibd').checked;
  const posttreat = document.getElementById('ctx-posttreat').checked;

  // Calculate utility score
  let utility = 50; // baseline
  
  // Cytology impact
  if (cytology === 'normal') utility -= 30;
  if (cytology === 'atypia') utility += 25;
  
  // Inflammation penalty (context-dependent)
  if (inflammation && doubt === 'reactive-vs-lgd') utility -= 25;
  if (ulcer && doubt === 'reactive-vs-lgd') utility -= 20;
  
  // Organ-specific modifiers
  if (organ === 'bladder' && doubt === 'reactive-vs-lgd' && cytology === 'borderline') utility += 15;
  if ((organ === 'colon-ibd' || ibd) && inflammation) utility -= 30;
  if (organ === 'gastric' && hpylori && doubt === 'reactive-vs-lgd') utility -= 15;
  
  // Doubt type
  if (doubt === 'lgd-vs-hgd') utility += 25;
  if (doubt === 'hgd-vs-cancer') utility += 20;
  if (doubt === 'indefinite' && ibd && inflammation) utility -= 35;
  
  // Clamp between 10-90
  utility = Math.max(10, Math.min(90, utility));
  
  // Determine recommendation
  let badge, recommendation, reasoning, alternatives, interpretation;
  
  if (utility >= 70) {
    badge = 'yes';
    recommendation = 'üü¢ p53 RACCOMANDATO';
    reasoning = generateReasoningHigh(organ, doubt, cytology, inflammation, ibd, hpylori, utility);
    interpretation = generateInterpretationGuidance(organ, doubt);
    alternatives = '';
  } else if (utility >= 45) {
    badge = 'maybe';
    recommendation = 'üü° p53 OPZIONALE';
    reasoning = generateReasoningMedium(organ, doubt, cytology, inflammation, ibd, hpylori, utility);
    interpretation = generateInterpretationGuidance(organ, doubt);
    alternatives = generateAlternatives(organ, doubt, inflammation, ibd, hpylori, ulcer);
  } else {
    badge = 'no';
    recommendation = 'üî¥ p53 NON RACCOMANDATO ORA';
    reasoning = generateReasoningLow(organ, doubt, cytology, inflammation, ibd, hpylori, utility);
    interpretation = '';
    alternatives = generateAlternatives(organ, doubt, inflammation, ibd, hpylori, ulcer);
  }
  
  // Build output
  let html = `
    <div class="result-box">
      <div style="margin-bottom: 16px;">
        <span class="badge badge-${badge}" style="font-size: 1.1rem; padding: 10px 18px;">${recommendation}</span>
        <div class="confidence" style="margin-top: 12px;">
          <span>Utilit√† diagnostica: <strong>${utility}%</strong></span>
          ${getStars(utility)}
        </div>
      </div>
      
      <h3>Perch√© ${badge === 'yes' ? 'raccomandato' : badge === 'maybe' ? 'opzionale' : 'non raccomandato ora'}:</h3>
      ${reasoning}
      
      ${interpretation ? `
      <h3>Se fai p53, come interpretare:</h3>
      ${interpretation}
      ` : ''}
      
      ${alternatives ? `
      <h3>Alternativa consigliata:</h3>
      ${alternatives}
      ` : ''}
      
      ${badge === 'yes' || badge === 'maybe' ? `
      <div style="margin-top: 20px;">
        <button class="btn" onclick="goToInterpret('${organ}')">‚û°Ô∏è Ho fatto p53, interpreto il risultato</button>
      </div>
      ` : ''}
    </div>
  `;
  
  document.getElementById('decision-result').innerHTML = html;
  document.getElementById('decision-output').classList.add('show');
  document.getElementById('decision-output').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function generateReasoningHigh(organ, doubt, cytology, inflammation, ibd, hpylori, utility) {
  let reasons = '<ul>';
  
  if (cytology === 'atypia') reasons += '<li>Citologia <strong>francamente atipica</strong> ‚Üí alta probabilit√† displasia</li>';
  if (cytology === 'borderline' && !inflammation) reasons += '<li>Citologia borderline + <strong>no infiammazione attiva</strong> ‚Üí contesto favorevole</li>';
  if (doubt === 'lgd-vs-hgd') reasons += '<li>Dubbio LGD vs HGD ‚Üí p53 OE (>60%) discrimina bene</li>';
  if (organ === 'bladder') reasons += '<li>Vescica: p53-OE frequente in HGD (40-60%), cutoff >50%</li>';
  if (!ibd && organ.includes('colon')) reasons += '<li>Colon non-IBD ‚Üí no falsi positivi da infiammazione</li>';
  
  reasons += `<li>Probabilit√† di fornire informazione diagnostica utile: <strong>${utility}%</strong></li>`;
  reasons += '</ul>';
  
  return reasons;
}

function generateReasoningMedium(organ, doubt, cytology, inflammation, ibd, hpylori, utility) {
  let reasons = '<ul>';
  
  if (inflammation) reasons += '<li>‚ö†Ô∏è Infiammazione attiva pu√≤ dare <strong>accumulo p53 da stress</strong> (10-40%) senza mutazione</li>';
  if (hpylori && organ === 'gastric') reasons += '<li>‚ö†Ô∏è H. pylori attivo ‚Üí rigenerazione marcata pu√≤ aumentare p53</li>';
  if (ibd && inflammation) reasons += '<li>‚ö†Ô∏è IBD attiva ‚Üí p53 20-50% frequente per stress, NON per mutazione TP53</li>';
  if (cytology === 'borderline') reasons += '<li>Citologia borderline ‚Üí p53 pu√≤ aiutare ma non sempre conclusivo</li>';
  
  reasons += `<li>Utilit√† diagnostica stimata: <strong>${utility}%</strong> (moderata)</li>`;
  reasons += '</ul>';
  
  return reasons;
}

function generateReasoningLow(organ, doubt, cytology, inflammation, ibd, hpylori, utility) {
  let reasons = '<ul>';
  
  if (cytology === 'normal') reasons += '<li>Citologia <strong>normale</strong> ‚Üí p53 sar√† probabilmente wild-type, non discriminante</li>';
  if (inflammation && doubt === 'reactive-vs-lgd') reasons += '<li>Infiammazione marcata + dubbio reattivo vs displasia ‚Üí <strong>alto rischio falso positivo</strong></li>';
  if (ibd && inflammation) reasons += '<li>IBD attiva ‚Üí p53 accumulo 20-50% comune per stress (non mutazione)</li>';
  if (hpylori && organ === 'gastric') reasons += '<li>H. pylori non eradicato ‚Üí rigenerazione confonde il quadro</li>';
  
  reasons += `<li>Utilit√† diagnostica: <strong>${utility}%</strong> (bassa)</li>`;
  reasons += '</ul>';
  
  return reasons;
}

function generateInterpretationGuidance(organ, doubt) {
  const cutoff = CUTOFFS[organ];
  
  return `
    <div class="alert alert-info">
      <strong>Cutoff ${ORGAN_NAMES[organ]}:</strong> Wild-type &lt;${cutoff.wt}% | Zona grigia ${cutoff.wt}-${cutoff.oe}% | Over-expression <strong>&gt;${cutoff.oe}%</strong> diffuso
      <br><br>
      <strong>Se p53 &lt;${cutoff.wt}%:</strong> Wild-type ‚Üí ${doubt === 'reactive-vs-lgd' ? 'Probabile reattivo/rigenerativo' : 'Non supporta HGD'}<br>
      <strong>Se p53 ${cutoff.wt}-${cutoff.oe}%:</strong> Zona grigia ‚Üí ${doubt === 'reactive-vs-lgd' ? 'LGD borderline, <strong>considera Ki67</strong>, ripeti biopsia' : 'LGD probabile, <strong>considera Ki67</strong>'}<br>
      <strong>Se p53 &gt;${cutoff.oe}%:</strong> Over-expression ‚Üí ${doubt === 'reactive-vs-lgd' ? 'Displasia confermata (LGD/HGD)' : 'HGD probabile'}
    </div>
  `;
}

function generateAlternatives(organ, doubt, inflammation, ibd, hpylori, ulcer) {
  let alt = '<div class="alert alert-warning">';
  
  if (hpylori && organ === 'gastric') {
    alt += '<strong>‚úì Eradica H. pylori PRIMA</strong><br>';
    alt += '‚úì Ripeti biopsia dopo 2-3 mesi<br>';
    alt += '‚úì Se persiste atipia ‚Üí ALLORA fai p53<br>';
  } else if (ibd && inflammation) {
    alt += '<strong>‚úì Tratta IBD aggressivamente (remissione)</strong><br>';
    alt += '‚úì Ripeti biopsia dopo 2-4 settimane in fase quiescente<br>';
    alt += '‚úì SE persiste atipia in remissione ‚Üí ALLORA fai p53 (pi√π affidabile)<br>';
  } else if (inflammation || ulcer) {
    alt += '<strong>‚úì Tratta infiammazione/ulcera</strong><br>';
    alt += '‚úì Ripeti biopsia dopo guarigione<br>';
    alt += '‚úì Se persiste atipia ‚Üí considera p53<br>';
  }
  
  if (doubt === 'reactive-vs-lgd') {
    alt += '<br><strong>AGGIUNGI (se disponibile):</strong><br>';
    alt += '‚Ä¢ <strong>Ki67</strong> (se >30% esteso ai 2/3 superficiali ‚Üí favorisce displasia)<br>';
    alt += '‚Ä¢ Correlazione endoscopica (lesione visibile?)<br>';
  }
  
  alt += '</div>';
  return alt;
}

function getStars(utility) {
  const count = Math.round(utility / 20);
  let stars = '';
  for (let i = 0; i < count; i++) stars += '<span class="star">‚≠ê</span>';
  return stars;
}

function goToInterpret(organ) {
  document.getElementById('int-organ').value = organ;
  // FIX: trova il tab button corretto e passalo alla funzione
  const interpretTab = document.querySelector('.tab[data-tab="interpret"]');
  switchTab('interpret', interpretTab);
  document.getElementById('tab-interpret').scrollIntoView({ behavior: 'smooth' });
}

function resetDecision() {
  document.getElementById('dec-organ').selectedIndex = 0;
  updateDoubtOptions(); // Reset doubt options based on organ
  document.getElementById('dec-doubt').selectedIndex = 0;
  document.querySelectorAll('input[name="cytology"]')[1].checked = true;
  document.querySelectorAll('.checkbox-group input[type="checkbox"]').forEach(cb => cb.checked = false);
  document.getElementById('decision-output').classList.remove('show');
}

// ============ INTERPRETATION ANALYSIS ============
function updatePercentDisplay() {
  const val = document.getElementById('int-percent').value;
  document.getElementById('percent-display').textContent = val;
}

function analyzeInterpretation() {
  const organ = document.getElementById('int-organ').value;
  const percent = parseInt(document.getElementById('int-percent').value);
  const intensity = document.getElementById('int-intensity').value;
  const distribution = document.getElementById('int-distribution').value;
  const control = document.getElementById('int-control').value;
  const special = document.getElementById('int-special').value;
  const ki67 = document.getElementById('int-ki67').value;
  
  const cutoff = CUTOFFS[organ] || CUTOFFS['colon']; // fallback per colon-ibd
  
  // Determine pattern
  let pattern, badge, interpretation, confidence, reportText;
  
  // FIX BUG #4: Validazione null con % > 5%
  if (special === 'null' && percent > 5) {
    pattern = 'ni';
    badge = 'ni';
    interpretation = `<strong>‚ö†Ô∏è DATI INCONGRUENTI</strong><br>
      Hai selezionato pattern NULL ma % nuclei positivi = ${percent}%.<br>
      Pattern NULL = <strong>0% nuclei positivi</strong> (max 5% per artefatti).<br><br>
      <strong>Azione:</strong> Correggi % a 0-5% se pattern √® realmente null, oppure rimuovi "pattern speciale" se c'√® positivit√† nucleare significativa.`;
    confidence = 0;
    reportText = `p53: DATI INCONGRUENTI - pattern null selezionato ma ${percent}% positivi. Verificare.`;
  }
  // Special patterns override - NULL valido
  else if (special === 'null' && control === 'strong') {
    pattern = 'null';
    badge = 'null';
    interpretation = '<strong>Pattern NULL aberrante</strong><br>0% nuclei positivi con controllo interno forte = mutazione inattivante TP53.<br><strong>Displasia confermata</strong> (pattern aberrante definitivo).';
    confidence = 90;
    reportText = `p53: Pattern NULL (0% nuclei positivi, controllo interno forte). Pattern aberrante confermato, mutazione TP53 inattivante. Displasia confermata.`;
  } else if (special === 'null' && control !== 'strong') {
    pattern = 'ni';
    badge = 'ni';
    interpretation = '<strong>NON INTERPRETABILE</strong><br>‚ö†Ô∏è Controllo interno assente/debole: impossibile confermare pattern null.<br><strong>RIPETERE colorazione con controlli appropriati.</strong>';
    confidence = 0;
    reportText = `p53: Non interpretabile (controllo interno inadeguato). RIPETERE.`;
  } 
  // FIX BUG #2: Pattern citoplasmatico con soglia pi√π stretta (<=10%) + gestione % > 10%
  else if (special === 'cytoplasmic' && percent <= 10) {
    pattern = 'cyto';
    badge = 'null';
    interpretation = `<strong>Pattern CITOPLASMATICO ABERRANTE (raro)</strong><br>
      Sequestro citoplasmatico con nuclei negativi/molto deboli (${percent}%).<br>
      <strong>Meccanismo:</strong> Mutazioni NES (Nuclear Export Signal) o esoni 9-10 che alterano la localizzazione nucleare.<br>
      <strong>Significato clinico:</strong> Equivale a mutazione funzionale TP53, prognosi simile a pattern null.<br>
      <strong>Displasia confermata</strong> (pattern aberrante definitivo).<br><br>
      ‚ö†Ô∏è <strong>Non confondere con:</strong><br>
      ‚Ä¢ Colorazione aspecifica (tipicamente granulare)<br>
      ‚Ä¢ Artefatti di fissazione (eterogenei)<br>
      ‚Ä¢ Cross-reazioni (validare con controlli)<br><br>
      <em>Nota: Pattern raro nei carcinomi endometriali (~1%, K√∂bel 2019); dati scarsi per displasie.</em>`;
    confidence = 85;
    reportText = `p53: Pattern citoplasmatico aberrante (sequestro citoplasmatico, nuclei negativi/molto deboli ${percent}%). Mutazioni NES o esoni 9-10. Pattern aberrante confermato, equivale a mutazione funzionale. Displasia confermata.`;
  }
  // FIX BUG #2: Citoplasmatico selezionato ma % > 10% ‚Üí pattern misto, non citoplasmatico puro
  else if (special === 'cytoplasmic' && percent > 10) {
    pattern = 'mild';
    badge = 'mild';
    interpretation = `<strong>Pattern MISTO (non citoplasmatico puro)</strong><br>
      Hai selezionato "citoplasmatico" ma ${percent}% nuclei sono positivi.<br>
      Pattern citoplasmatico puro = nuclei negativi (0-10%).<br><br>
      <strong>Questo √® un pattern misto:</strong> positivit√† citoplasmatica + nucleare.<br>
      Interpreta come <strong>zona grigia/borderline</strong>.<br><br>
      <strong>Azione:</strong> Valuta se la positivit√† nucleare √® real (2+/3+) o artefatto. Se nuclei 2+/3+ diffusi, considera over-expression. <strong>Considera NGS TP53</strong> per chiarire.`;
    confidence = 40;
    reportText = `p53: Pattern misto citoplasmatico + nucleare (${percent}% nuclei positivi). Non pattern citoplasmatico puro. Zona grigia, considerare NGS TP53.`;
  }
  else if (percent < cutoff.wt) {
    pattern = 'wt';
    badge = 'wt';
    interpretation = `<strong>Wild-type</strong><br>${percent}% √® sotto il cutoff wild-type ${ORGAN_NAMES[organ] || 'Colon'} (<${cutoff.wt}%).<br>`;
    if (distribution === 'mosaic') interpretation += 'Distribuzione mosaico conferma pattern wild-type.<br>';
    interpretation += '<strong>Funzione p53 normale</strong>, non supporta displasia di alto grado.';
    confidence = distribution === 'mosaic' ? 85 : 70;
    reportText = `p53: Wild-type (${percent}% nuclei positivi, distribuzione ${distribution}). Pattern normale, non supporta displasia di alto grado.`;
  } else if (percent >= cutoff.oe && distribution === 'diffuse' && (intensity === '2' || intensity === '3')) {
    pattern = 'oe';
    badge = 'oe';
    interpretation = `<strong>Over-expression</strong><br>${percent}% √® SOPRA il cutoff ${ORGAN_NAMES[organ] || 'Colon'} (>${cutoff.oe}%).<br>`;
    interpretation += 'Distribuzione diffusa uniforme + intensit√† 2+/3+ forte.<br>';
    interpretation += '<strong>Pattern aberrante confermato</strong> ‚Üí Displasia (HGD probabile se morfologia concorda).';
    confidence = 90;
    reportText = `p53: Over-expression (${percent}% nuclei positivi 2+/3+, distribuzione diffusa uniforme). Pattern aberrante confermato. ${organ === 'bladder' ? 'Displasia uroteliale' : 'Displasia'} con p53 over-expression.`;
  } else if (percent >= cutoff.wt && percent < cutoff.oe) {
    pattern = 'mild';
    badge = 'mild';
    interpretation = `<strong>Accumulo lieve (zona grigia)</strong><br>${percent}% √® nella zona grigia (${cutoff.wt}-${cutoff.oe}%).<br>`;
    interpretation += 'Sopra il wild-type ma sotto il cutoff over-expression.<br>';
    if (distribution === 'focal') interpretation += 'Distribuzione focale (non uniforme) favorisce LGD o stress cellulare.<br>';
    interpretation += '<strong>Non diagnostico</strong> ‚Üí Ripeti biopsia per conferma. <strong>Considera Ki67</strong> se disponibile.';
    confidence = 45;
    reportText = `p53: Accumulo lieve (${percent}% nuclei positivi, distribuzione ${distribution}). Zona grigia, non diagnostico per over-expression. ${distribution === 'focal' ? 'Compatibile con LGD borderline o stress cellulare.' : 'Ripeti biopsia consigliata.'}`;
  } else if (percent >= cutoff.oe && (distribution === 'focal' || intensity === '1')) {
    pattern = 'mild';
    badge = 'mild';
    interpretation = `<strong>Borderline over-expression</strong><br>${percent}% √® sopra ${cutoff.oe}%, MA:<br>`;
    if (distribution === 'focal') interpretation += '‚Ä¢ Distribuzione focale (non diffuso uniforme)<br>';
    if (intensity === '1') interpretation += '‚Ä¢ Intensit√† prevalente debole (1+)<br>';
    interpretation += '<strong>Pattern non classico</strong> ‚Üí LGD probabile, HGD meno probabile. Ripeti biopsia. <strong>Considera Ki67</strong>.';
    confidence = 55;
    reportText = `p53: Borderline (${percent}% nuclei positivi, ma distribuzione ${distribution} e intensit√† ${intensity}+). Non pattern classico over-expression. LGD probabile, ripeti biopsia.`;
  } else {
    pattern = 'wt';
    badge = 'wt';
    interpretation = `<strong>Wild-type / Accumulo lieve</strong><br>${percent}% nuclei positivi.<br>Pattern non definitivo per over-expression. Compatibile con wild-type o accumulo lieve.`;
    confidence = 60;
    reportText = `p53: ${percent}% nuclei positivi, distribuzione ${distribution}. Pattern non definitivo, compatibile con wild-type o accumulo lieve.`;
  }
  
  // ============ Ki67 INTEGRATION ============
  // FIX miglioramento #7: Soglia Ki67 concordanza abbassata per zona grigia
  if (pattern === 'mild' && ki67 !== 'unknown') {
    let ki67Message = '';
    let confidenceBoost = 0;
    
    // Usa soglia pi√π bassa per zona grigia (>= cutoff.wt invece di >= 30)
    const inGrayZone = percent >= cutoff.wt && percent < cutoff.oe;
    
    // Concordanti: p53 accumulo + Ki67 alto ‚Üí displasia
    if ((organ === 'gastric' || organ === 'colon' || organ === 'colon-ibd') && ki67 === 'high' && inGrayZone) {
      ki67Message = '<br><br>‚ö†Ô∏è <strong>Ki67 CONCORDANTE:</strong> Ki67 alto esteso (>30% ai 2/3 superiori) favorisce <strong>DISPLASIA</strong> su base reattiva. Pattern p53 + Ki67 concordano ‚Üí aumenta probabilit√† displasia. Ricorda: <strong>distribuzione</strong> Ki67 pi√π importante della % (Fassan 2014).';
      confidenceBoost = 20;
      reportText += ` Ki67 alto esteso ai 2/3 superiori (concordante), favorisce displasia.`;
    } 
    // Concordanti: p53 basso + Ki67 basale ‚Üí reattivo
    else if (ki67 === 'basal' && percent <= cutoff.wt + 10) {
      ki67Message = '<br><br>‚úì <strong>Ki67 CONCORDANTE:</strong> Basale <10% favorisce <strong>REATTIVO/rigenerativo</strong>. Pattern p53 + Ki67 concordano ‚Üí aumenta probabilit√† reattivo.';
      confidenceBoost = 15;
      reportText += ` Ki67 basale <10% (concordante), favorisce reattivo.`;
    }
    // Vescica/Laringe/Esofago: Ki67 full-thickness
    else if ((organ === 'bladder' || organ === 'larynx' || organ === 'esophagus') && (ki67 === 'high' || ki67 === 'moderate')) {
      ki67Message = '<br><br>‚ö†Ô∏è <strong>Ki67 supportivo:</strong> Full-thickness/esteso favorisce <strong>DISPLASIA</strong>.';
      confidenceBoost = 10;
      reportText += ` Ki67 full-thickness/esteso, favorisce displasia.`;
    }
    // DISCORDANTI: p53 alto + Ki67 basso O viceversa
    else if ((ki67 === 'high' && percent < cutoff.wt) || (ki67 === 'basal' && percent > cutoff.oe - 10)) {
      ki67Message = '<br><br>‚ö†Ô∏è <strong>Ki67 DISCORDANTE:</strong> Pattern p53 e Ki67 non concordano (possibile stress/artefatto vs displasia iniziale). <strong>Ripeti biopsia</strong> consigliata per disambiguare. Considera anche NGS se clinicamente rilevante.';
      confidenceBoost = -10; // riduce confidence
      reportText += ` Ki67 discordante con p53 (pattern non concordante), ripeti biopsia.`;
    }
    // Ki67 moderato: non diagnostico ma segnala
    else if (ki67 === 'moderate') {
      ki67Message = '<br><br>üí° <strong>Ki67 moderato (10-30%):</strong> Non diagnostico, compatibile con LGD borderline. Pattern distribuzione pi√π importante della %.';
      confidenceBoost = 5;
      reportText += ` Ki67 moderato (10-30%), compatibile con LGD borderline.`;
    }
    
    interpretation += ki67Message;
    confidence = Math.max(0, Math.min(100, confidence + confidenceBoost));
  }
  
  // Add organ-specific notes
  let organNotes = '';
  if ((organ === 'colon' || organ === 'colon-ibd') && percent >= 20 && percent <= 50) {
    organNotes = '<div class="alert alert-warning"><strong>‚ö†Ô∏è Nota colon:</strong> Accumulo 20-50% in colon pu√≤ essere dovuto a infiammazione attiva (stress cellulare) senza mutazione TP53. Verifica contesto clinico (IBD attiva?). Se IBD infiammata, ripeti dopo remissione.</div>';
  }
  if (organ === 'bladder' && percent > 50) {
    organNotes = '<div class="alert alert-info"><strong>‚ÑπÔ∏è Nota vescica:</strong> p53-OE √® frequente (40-60%) in HGD uroteliale. Questo risultato supporta displasia su base di iperplasia reattiva.</div>';
  }
  if (organ === 'gastric' && percent >= 10 && percent <= 50) {
    organNotes = '<div class="alert alert-warning"><strong>‚ö†Ô∏è Nota gastrico:</strong> Zona grigia 10-50%. Se H. pylori presente, pu√≤ essere accumulo da rigenerazione. Eradica e ripeti biopsia.</div>';
  }
  
  // Add discordance warning if pattern is ambiguous
  if (pattern === 'mild' && (percent >= 40 && percent <= 60)) {
    organNotes += '<div class="alert alert-info"><strong>üî¨ Discordanza possibile:</strong> Pattern borderline in zona grigia. Se clinica non concorda o necessario per terapie targeted, considera <strong>NGS TP53</strong> per conferma molecolare. <em>Nota: Dati discordanza derivano principalmente da CARCINOMI (8-15%); nelle displasie √® probabilmente minore (~5%).</em></div>';
  }
  
  // Build output with cutoff visualization
  const markerPos = Math.min(95, (percent / 100) * 100);
  
  let html = `
    <div class="result-box">
      <div style="margin-bottom: 16px;">
        <span class="badge badge-${badge}" style="font-size: 1.1rem; padding: 10px 18px;">${pattern.toUpperCase()}</span>
        <div class="confidence" style="margin-top: 12px;">
          <span>Confidence: <strong>${confidence}%</strong></span>
          ${getStars(confidence)}
        </div>
      </div>
      
      <div class="cutoff-visual">
        <h3>Cutoff ${ORGAN_NAMES[organ] || 'Colon'}</h3>
        <div class="cutoff-bar">
          <div class="cutoff-marker" style="left: ${markerPos}%;"></div>
        </div>
        <div class="cutoff-labels">
          <span><strong>WT</strong><br>0-${cutoff.wt}%</span>
          <span><strong>Grigio</strong><br>${cutoff.wt}-${cutoff.oe}%</span>
          <span><strong>OE</strong><br>${cutoff.oe}-100%</span>
        </div>
        <div style="text-align: center; margin-top: 12px; font-size: 0.9rem; color: var(--gray);">
          Il tuo risultato: <strong style="color: var(--danger);">${percent}%</strong>
        </div>
      </div>
      
      <h3>Interpretazione</h3>
      <div class="alert alert-info">
        ${interpretation}
      </div>
      
      ${organNotes}
      
      <h3>Testo per referto</h3>
      <div class="report-box" id="report-text">${reportText}</div>
      <button class="btn" onclick="copyReport()">üìã Copia testo referto</button>
    </div>
  `;
  
  document.getElementById('interpret-result').innerHTML = html;
  document.getElementById('interpret-output').classList.add('show');
  document.getElementById('interpret-output').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function copyReport() {
  const text = document.getElementById('report-text').textContent;
  navigator.clipboard.writeText(text).then(() => {
    const btn = event.target;
    const original = btn.textContent;
    btn.textContent = '‚úì Copiato!';
    setTimeout(() => btn.textContent = original, 2000);
  });
}

function resetInterpretation() {
  document.getElementById('int-organ').selectedIndex = 0;
  document.getElementById('int-percent').value = 50;
  updatePercentDisplay();
  document.getElementById('int-intensity').selectedIndex = 1;
  document.getElementById('int-distribution').selectedIndex = 2;
  document.getElementById('int-control').selectedIndex = 0;
  document.getElementById('int-special').selectedIndex = 0;
  document.getElementById('int-ki67').selectedIndex = 0;
  document.getElementById('special-warning').style.display = 'none';
  document.getElementById('interpret-output').classList.remove('show');
}

// Initialize
updatePercentDisplay();
updateDoubtOptions(); // Initialize doubt options based on default organ
</script>
</body>
</html>
